{% extends "finance/base.html" %}
{% load static %}

{% block content %}
<h1>Lançamentos (Receitas / Despesas)</h1>

<!-- {% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %} -->

<h2>Novo lançamento</h2>

<!-- Card selector nav (Débito + Credit Cards) -->
<div style="margin: 12px 0 20px 0;">
  <div id="card_selector" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <button type="button" class="card-btn" data-card-id="">Débito</button>
    {% for card in credit_cards %}
      <button type="button" class="card-btn" data-card-id="{{ card.id }}">{{ card.name }}</button>
    {% endfor %}
  </div>
</div>

<style>
  .transactions-layout { display: flex; gap: 24px; align-items: flex-start; }
  .transactions-layout .left-column { flex: 1 1 0; min-width: 320px; }
  .transactions-layout .right-column { width: 360px; max-width: 42%; }

  /* Form controls full width and spacing */
  .transactions-layout form div { margin-bottom: 12px; }
  .transactions-layout label { display: block; margin-bottom: 6px; font-weight: 600; }
  .transactions-layout input[type="text"],
  .transactions-layout input[type="date"],
  .transactions-layout input[type="number"],
  .transactions-layout input[type="month"],
  .transactions-layout select,
  .transactions-layout textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .transactions-layout button { padding: 8px 14px; border-radius: 4px; }

  /* Card selector buttons */
  .card-btn {
    background: #fff;
    border: 1px solid #ddd;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    color: #222; /* ensure readable text color when not selected */
  }
  .card-btn:hover { background: #f5f7fa; color: #111; }
  .card-btn.active { background: #1976d2; color: #fff; border-color: #1976d2; font-weight: 700; }

  /* Right column visual tweaks */
  .transactions-layout .right-column { background: #fafafa; padding: 12px; border-radius: 6px; border: 1px solid #eee; }
  .transactions-layout .right-column table { width: 100%; border-collapse: collapse; }
  .transactions-layout .right-column th,
  .transactions-layout .right-column td { border: 1px solid #e6e6e6; padding: 8px; }

  @media (max-width: 900px) {
    .transactions-layout { flex-direction: column; }
    .transactions-layout .right-column { width: 100%; max-width: none; }
  }
  /* two-column small form rows (e.g., Tipo + Categoria) */
  .two-columns { display: flex; gap: 12px; }
  .two-columns > div { flex: 1; }
  @media (max-width: 600px) { .two-columns { flex-direction: column; } }
</style>
  <div class="two-columns">
    <div>
      <label for="id_type">Tipo:</label>
      <select id="id_type" name="type" required>
        <option value="IN">Receita</option>
        <option value="EX">Despesa</option>
      </select>
    </div>

    <div>
      <label for="id_category">Categoria:</label>
      <select id="id_category" name="category" required>
        <option value="">-- selecione --</option>
        {% for c in categories %}
          <option value="{{ c.id }}">{{ c.name }}{% if c.is_income %} (receita){% endif %}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div>
    <label for="id_amount">Valor:</label>
    <input type="number" id="id_amount" name="amount" step="0.01" min="0" required>
  </div>

  <div>
    <label for="id_category">Categoria:</label>
    <select id="id_category" name="category" required>
      <option value="">-- selecione --</option>
      {% for c in categories %}
        <option value="{{ c.id }}">{{ c.name }}{% if c.is_income %} (receita){% endif %}</option>
      {% endfor %}
    </select>
  </div>

  <!-- <div>
    <label for="id_account">Conta:</label>
    <select id="id_account" name="account" required>
      <option value="">-- selecione --</option>
      {% for a in accounts %}
        <option value="{{ a.id }}">{{ a.name }}</option>
      {% endfor %}
    </select>
  </div> -->

  <!-- credit_card select removed: selection is done via the card selector nav above -->

  <div>
    <label for="id_description">Descrição:</label>
    <input type="text" id="id_description" name="description">
  </div>

  <fieldset style="margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
    <legend>Compra parcelada no cartão</legend>

    <div>
      <label>
        <input type="checkbox" name="is_installment" id="id_is_installment" onchange="toggleInstallmentFields()">
        Lançar como compra parcelada?
      </label>
    </div>

    <div id="installment_fields" style="margin-top: 8px; display: none;">
      <div>
        <label for="id_installments">Número de parcelas:</label>
        <input type="number" id="id_installments" name="installments" min="2" value="2">
      </div>
      <small>
        O valor informado acima será considerado o <strong>valor total da compra</strong>.
        O sistema irá criar uma transação por parcela, em meses consecutivos.
      </small>
    </div>
  </fieldset>

  <div style="margin-top: 12px;">
    <button type="submit">Salvar</button>
  </div>

    </form>

  </div>

  <aside class="right-column">
    <h2 style="margin-top: 0;">Saldo das Contas</h2>

    <section style="margin-bottom: 16px;">
      {% if accounts %}
        <ul style="list-style: none; padding: 0; margin: 0 0 8px 0;">
          {% for a in accounts %}
            <li style="display:flex; justify-content:space-between; padding:6px 8px; border-radius:4px; background:#fff; margin-bottom:6px; align-items:center;">
              <span style="font-weight:600;">{{ a.name }}</span>
              <span style="font-family: monospace;">R$ {{ a.balance|floatformat:2 }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="color:#666; margin:0 0 8px 0;">Nenhuma conta cadastrada.</p>
      {% endif %}
    </section>

    <h2 style="margin-top: 0;">Faturas dos Cartões de Crédito</h2>
    <div style="margin-bottom: 20px;">
      <label for="invoice_month" style="display: block; margin-bottom: 5px;">Mês/Ano:</label>
      <input type="month" id="invoice_month" name="invoice_month" 
             value="{{ selected_year }}-{% if selected_month < 10 %}0{% endif %}{{ selected_month }}"
             onchange="updateInvoiceMonth()" style="width: 200px;">
      <button type="button" onclick="updateInvoiceMonth()" style="margin-left: 10px;">Atualizar</button>
    </div>

    {% if credit_card_invoices %}
      <table border="1" cellspacing="0" cellpadding="8" style="width: 100%; margin-bottom: 20px;">
        <thead>
          <tr>
            <th style="text-align: left;">Cartão</th>
            <th style="text-align: right;">Total</th>
            <th style="text-align: center;">Status</th>
            <th style="text-align: center;">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in credit_card_invoices %}
            {% if invoice.count > 0 %}
              <tr>
                <td>{{ invoice.card.name }}</td>
                <td style="text-align: right; font-weight: bold;">
                  R$ {{ invoice.total|floatformat:2 }}
                  <small style="display: block; font-weight: normal; color: #666;">
                    ({{ invoice.count }} lançamento{% if invoice.count > 1 %}s{% endif %})
                  </small>
                </td>
                <td style="text-align: center;">
                  {% if invoice.is_paid %}
                    <span style="color: #4caf50; font-weight: bold;">✓ Paga</span>
                  {% else %}
                    <span style="color: #ff9800; font-weight: bold;">Pendente</span>
                  {% endif %}
                </td>
                <td style="text-align: center;">
                  {% if invoice.is_paid %}
                    <a href="{% url 'finance:reopen_invoice' invoice.card.id selected_year selected_month %}" 
                       style="color: #ff9800; margin-right: 10px;">Reabrir Fatura</a>
                  {% else %}
                    <a href="{% url 'finance:pay_invoice' invoice.card.id selected_year selected_month %}" 
                       style="color: #4caf50; font-weight: bold;">Pagar Fatura</a>
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="color: #666;">Nenhum cartão cadastrado ou nenhuma fatura no período selecionado.</p>
    {% endif %}

    <script>
      function updateInvoiceMonth() {
        const monthInput = document.getElementById('invoice_month');
        const value = monthInput.value;
        if (value) {
          const [year, month] = value.split('-');
          window.location.href = '{% url "finance:transactions" %}?year=' + year + '&month=' + month;
        }
      }
    </script>
  </aside>

</div>

<h2>Últimos lançamentos</h2>

{% if transactions %}
  <table border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th>Data Lançamento</th>
        <th>Data Pagamento</th>
        <th>Tipo</th>
        <th>Valor</th>
        <th>Categoria</th>
        <th>Conta</th>
        <th>Cartão</th>
        <th>Descrição</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for t in transactions %}
        <tr>
          <td>{{ t.date|date:"d/m/Y" }}</td>
          <td>
            {% if t.payment_date %}
              {{ t.payment_date|date:"d/m/Y" }}
              {% if t.date != t.payment_date %}
                <small style="color: #666; display: block;">(vencimento)</small>
              {% endif %}
            {% else %}
              {{ t.date|date:"d/m/Y" }}
            {% endif %}
          </td>
          <td>
            {% if t.type == "IN" %}
              Receita
            {% else %}
              Despesa
            {% endif %}
          </td>
          <td>
            {% if t.type == "EX" %}-{% endif %}
            R$ {{ t.amount }}
          </td>
          <td>{{ t.category.name }}</td>
          <td>{{ t.account.name }}</td>
          <td>{{ t.credit_card.name|default:"-" }}</td>
          <td>{{ t.description }}</td>
          <td>
            <a href="{% url 'finance:edit_transaction' t.id %}" style="margin-right: 8px;">Editar</a>
            <form method="post" action="{% url 'finance:delete_transaction' t.id %}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja deletar este lançamento?');">
              {% csrf_token %}
              <button type="submit" class="logout-link" style="color: #c62828; padding: 0; margin: 0;">Deletar</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>Nenhum lançamento encontrado.</p>
{% endif %}

<script>
  function toggleInstallmentFields() {
    const chk = document.getElementById('id_is_installment');
    const box = document.getElementById('installment_fields');
    box.style.display = chk.checked ? 'block' : 'none';
  }
</script>

<script>
  // Card selector behaviour: persist selection in localStorage and inject hidden input into the form
  (function(){
    const selector = document.getElementById('card_selector');
    if (!selector) return;
    const buttons = Array.from(selector.querySelectorAll('.card-btn'));
    const storageKey = 'selected_card_id';

    function setActive(button){
      buttons.forEach(b => b.classList.toggle('active', b === button));
      const id = button.getAttribute('data-card-id') || '';
      try { localStorage.setItem(storageKey, id); } catch(e) {}
    }

    buttons.forEach(btn => btn.addEventListener('click', function(){ setActive(btn); }));

    // Initialize
    let saved = null;
    try { saved = localStorage.getItem(storageKey); } catch(e) { saved = null; }
    let initial = buttons.find(b => b.getAttribute('data-card-id') === saved) || buttons[0];
    setActive(initial);

    // On submit, ensure a hidden input named 'credit_card' is present with the selected id (or empty for debit)
    const form = document.querySelector('.transactions-layout .left-column form');
    if (form){
      form.addEventListener('submit', function(){
        let hidden = form.querySelector('input[name="credit_card"]');
        if (!hidden){
          hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'credit_card';
          form.appendChild(hidden);
        }
        const active = selector.querySelector('.card-btn.active');
        hidden.value = active ? (active.getAttribute('data-card-id') || '') : '';
      });
    }
  })();
</script>

{% endblock %}
