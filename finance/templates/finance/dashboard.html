{% extends "finance/base.html" %}
{% load static %}

{% block content %}
<h1>Dashboard</h1>

<!-- Filtros de PerÃ­odo -->
<div style="background-color: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ddd;">
  <form method="get" action="">
    <div style="display: flex; gap: 15px; align-items: flex-end;">
      <div>
        <label for="id_year" style="display: block; font-weight: 600; margin-bottom: 5px;">Ano:</label>
        <input type="number" id="id_year" name="year" value="{{ year }}" min="2020" max="2100" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
      </div>
      <div>
        <label for="id_month" style="display: block; font-weight: 600; margin-bottom: 5px;">MÃªs:</label>
        <select id="id_month" name="month" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
          <option value="1" {% if month == 1 %}selected{% endif %}>Janeiro</option>
          <option value="2" {% if month == 2 %}selected{% endif %}>Fevereiro</option>
          <option value="3" {% if month == 3 %}selected{% endif %}>MarÃ§o</option>
          <option value="4" {% if month == 4 %}selected{% endif %}>Abril</option>
          <option value="5" {% if month == 5 %}selected{% endif %}>Maio</option>
          <option value="6" {% if month == 6 %}selected{% endif %}>Junho</option>
          <option value="7" {% if month == 7 %}selected{% endif %}>Julho</option>
          <option value="8" {% if month == 8 %}selected{% endif %}>Agosto</option>
          <option value="9" {% if month == 9 %}selected{% endif %}>Setembro</option>
          <option value="10" {% if month == 10 %}selected{% endif %}>Outubro</option>
          <option value="11" {% if month == 11 %}selected{% endif %}>Novembro</option>
          <option value="12" {% if month == 12 %}selected{% endif %}>Dezembro</option>
        </select>
      </div>
      <div>
        <button type="submit" style="padding: 6px 12px;">Aplicar</button>
      </div>
    </div>
  </form>
</div>

<style>
  .dashboard-grid {
    display: grid;
    grid-template-columns: 2.25fr 2.25fr 2fr;
    gap: 20px;
    margin-bottom: 30px;
  }

  @media (max-width: 1200px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }
  }

  .dashboard-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .dashboard-card h2 {
    margin-top: 0;
    font-size: 18px;
    color: #283593;
    border-bottom: 2px solid #e8eaf6;
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  .metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .metric:last-child {
    border-bottom: none;
  }

  .metric-label {
    font-weight: 600;
    color: #555;
  }

  .metric-value {
    font-size: 18px;
    font-weight: 700;
  }

  .metric-value.positive {
    color: #2e7d32;
  }

  .metric-value.negative {
    color: #c62828;
  }

  .metric-value.neutral {
    color: #283593;
  }

  .recent-transactions {
    margin-top: 10px;
  }

  .transaction-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
  }

  .transaction-item:last-child {
    border-bottom: none;
  }

  .invoice-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .invoice-item:last-child {
    border-bottom: none;
  }

  .invoice-card {
    font-weight: 600;
  }

  .invoice-amount {
    font-size: 16px;
    font-weight: 700;
    color: #c62828;
  }

  .no-data {
    color: #999;
    font-style: italic;
    text-align: center;
    padding: 20px;
  }

  #id_month {
    height: 30px;
  }
</style>

<!-- Resumo Financeiro -->
<div class="dashboard-grid">
  <div class="dashboard-card">
    <h2>ðŸ’° Resumo Financeiro</h2>
    <div class="metric">
      <span class="metric-label">Saldo Atual</span>
      <span class="metric-value neutral">R$ {{ total_balance|floatformat:2 }}</span>
    </div>
    <div class="metric">
      <span class="metric-label">Receitas do MÃªs</span>
      <span class="metric-value positive">R$ {{ month_income|floatformat:2 }}</span>
    </div>
    <div class="metric">
      <span class="metric-label">Despesas do MÃªs</span>
      <span class="metric-value negative">- R$ {{ month_expenses|floatformat:2 }}</span>
    </div>
    <div class="metric">
      <span class="metric-label">Saldo do MÃªs</span>
      <span class="metric-value {% if month_balance >= 0 %}positive{% else %}negative{% endif %}">
        R$ {{ month_balance|floatformat:2 }}
      </span>
    </div>
  </div>

  <div class="dashboard-card">
    <h2>ðŸ“Š Planejamento</h2>
    <div class="metric">
      <span class="metric-label">Saldo Projetado</span>
      <span class="metric-value {% if projected_balance >= 0 %}positive{% else %}negative{% endif %}">
        R$ {{ projected_balance|floatformat:2 }}
      </span>
    </div>
    <div class="metric">
      <span class="metric-label">Receitas Planejadas</span>
      <span class="metric-value {% if income_planned_percent <= 100 %}positive{% else %}negative{% endif %}">
        R$ {{ income_budget|floatformat:2 }} <span style="font-size: 14px; font-weight: 500;">({{ income_planned_percent|floatformat:1 }}%)</span>
      </span>
    </div>
    <div class="metric">
      <span class="metric-label">Despesas Planejadas</span>
      <span class="metric-value negative">
        - R$ {{ expense_budget|floatformat:2 }} <span style="font-size: 14px; font-weight: 500;">({{ expense_planned_percent|floatformat:1 }}%)</span>
      </span>
    </div>
    <div class="metric">
      <span class="metric-label">Saldo Planejado</span>
      <span class="metric-value {% if budget_diff >= 0 %}positive{% else %}negative{% endif %}">
        R$ {{ budget_diff|floatformat:2 }}
      </span>
    </div>
  </div>

  <div class="dashboard-card">
    <h2>ðŸ’³ Faturas dos CartÃµes</h2>
    {% if all_invoices %}
      {% for invoice in all_invoices %}
        <div class="invoice-item">
          <div>
            <div class="invoice-card">{{ invoice.card_name }}</div>
            <div style="font-size: 12px; color: #666;">
              {{ invoice.month }}/{{ invoice.year }}
              {% if invoice.is_paid %}
                <span style="color: #4caf50; font-weight: 600; margin-left: 5px;">âœ“ Paga</span>
              {% else %}
                <span style="color: #ff9800; font-weight: 600; margin-left: 5px;">âš  Pendente</span>
              {% endif %}
            </div>
          </div>
          <div class="invoice-amount" style="{% if invoice.is_paid %}color: #666;{% endif %}">R$ {{ invoice.total|floatformat:2 }}</div>
        </div>
      {% endfor %}
    {% else %}
      <div class="no-data">Nenhuma fatura no perÃ­odo</div>
    {% endif %}
  </div>
</div>

<!-- GrÃ¡fico de Subcategorias -->
<div class="dashboard-card" style="margin-bottom: 30px;">
  <h2>ðŸ“Š Gasto vs OrÃ§ado por Subcategoria</h2>
  <canvas id="subcategoriesChart" style="max-height: 500px;"></canvas>
  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; font-size: 12px; color: #666;">
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 30px; height: 2px; border-top: 2px dashed rgba(46, 125, 50, 0.8);"></div>
      <span>Linha tracejada verde = Valor OrÃ§ado (referÃªncia)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 20px; height: 12px; background-color: rgba(33, 150, 243, 0.7); border: 2px solid rgba(33, 150, 243, 1);"></div>
      <span>Azul = &lt; 85% do orÃ§ado</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 20px; height: 12px; background-color: rgba(255, 152, 0, 0.7); border: 2px solid rgba(255, 152, 0, 1);"></div>
      <span>Laranja = 85% - 100% do orÃ§ado</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 20px; height: 12px; background-color: rgba(198, 40, 40, 0.7); border: 2px solid rgba(198, 40, 40, 1);"></div>
      <span>Vermelho = &gt; 100% do orÃ§ado ou sem orÃ§amento</span>
    </div>
  </div>
</div>

<!-- Ãšltimas TransaÃ§Ãµes -->
<div class="dashboard-card">
  <h2>ðŸ•’ Ãšltimas TransaÃ§Ãµes</h2>
  {% if recent_transactions %}
    <div class="recent-transactions">
      {% for t in recent_transactions %}
        <div class="transaction-item">
          <div>
            <span style="font-weight: 600;">{{ t.date|date:"d/m/Y" }}</span> - 
            {{ t.description|default:"Sem descriÃ§Ã£o" }}
            <span style="color: #666; font-size: 12px;">({{ t.subcategory.category.name }})</span>
          </div>
          <div style="font-weight: 700; {% if t.type == 'IN' %}color: #2e7d32;{% else %}color: #c62828;{% endif %}">
            {% if t.type == 'EX' %}-{% endif %}R$ {{ t.amount|floatformat:2 }}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="no-data">Nenhuma transaÃ§Ã£o registrada</div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Dados do grÃ¡fico
  const chartData = {{ subcategories_chart_data|safe }};
  
  if (chartData && chartData.length > 0) {
    const labels = chartData.map(item => item.name);
    const spentData = chartData.map(item => item.spent);
    const budgetData = chartData.map(item => item.budget);
    
    // Calcular porcentagens e cores para as barras de gasto
    const percentages = [];
    const spentColors = [];
    const spentBorderColors = [];
    
    spentData.forEach((spent, index) => {
      const budget = budgetData[index];
      let percentage = 0;
      
      // Se nÃ£o hÃ¡ orÃ§amento mas hÃ¡ gasto, usar vermelho
      if (budget === 0 && spent > 0) {
        percentage = 101; // Valor maior que 100 para forÃ§ar vermelho
      } else if (budget > 0) {
        percentage = (spent / budget) * 100;
      }
      
      percentages.push(percentage);
      
      // Definir cores baseado na porcentagem
      if (budget === 0 && spent > 0) {
        // Vermelho quando nÃ£o hÃ¡ orÃ§amento mas hÃ¡ gasto
        spentColors.push('rgba(198, 40, 40, 0.7)'); // Vermelho com transparÃªncia
        spentBorderColors.push('rgba(198, 40, 40, 1)'); // Vermelho sÃ³lido
      } else if (percentage < 85) {
        // Azul para < 85%
        spentColors.push('rgba(33, 150, 243, 0.7)'); // Azul com transparÃªncia
        spentBorderColors.push('rgba(33, 150, 243, 1)'); // Azul sÃ³lido
      } else if (percentage <= 100) {
        // Laranja para 85% - 100%
        spentColors.push('rgba(255, 152, 0, 0.7)'); // Laranja com transparÃªncia
        spentBorderColors.push('rgba(255, 152, 0, 1)'); // Laranja sÃ³lido
      } else {
        // Vermelho para > 100%
        spentColors.push('rgba(198, 40, 40, 0.7)'); // Vermelho com transparÃªncia
        spentBorderColors.push('rgba(198, 40, 40, 1)'); // Vermelho sÃ³lido
      }
    });
    
    // Plugin customizado para adicionar porcentagens no topo das barras de gasto
    const percentageLabelPlugin = {
      id: 'percentageLabel',
      afterDatasetsDraw: function(chart) {
        const ctx = chart.ctx;
        const meta = chart.getDatasetMeta(0); // Dataset de "Gasto"
        const yScale = chart.scales.y;
        
        ctx.save();
        ctx.font = 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        
        meta.data.forEach((bar, index) => {
          const percentage = percentages[index];
          const budget = budgetData[index];
          const spent = spentData[index];
          
          // Desenhar linha de referÃªncia horizontal para o valor orÃ§ado
          if (budget > 0) {
            const budgetY = yScale.getPixelForValue(budget);
            const barLeft = bar.x - bar.width / 2;
            const barRight = bar.x + bar.width / 2;
            
            // Linha tracejada verde
            ctx.strokeStyle = 'rgba(46, 125, 50, 0.8)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(barLeft, budgetY);
            ctx.lineTo(barRight, budgetY);
            ctx.stroke();
            ctx.setLineDash([]);
          }
          
          // Adicionar porcentagem no topo da barra de gasto
          if (spent > 0) {
            const x = bar.x;
            const y = bar.y;
            let text;
            
            // Se nÃ£o hÃ¡ orÃ§amento, mostrar "N/A"
            if (budget === 0) {
              text = 'N/A';
            } else {
              text = percentage.toFixed(1) + '%';
            }
            
            // Cor do texto baseada na porcentagem ou se nÃ£o hÃ¡ orÃ§amento
            ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            if (budget === 0 && spent > 0) {
              ctx.fillStyle = 'rgba(198, 40, 40, 1)'; // Vermelho para sem orÃ§amento
            } else if (percentage < 85) {
              ctx.fillStyle = 'rgba(33, 150, 243, 1)'; // Azul
            } else if (percentage <= 100) {
              ctx.fillStyle = 'rgba(255, 152, 0, 1)'; // Laranja
            } else {
              ctx.fillStyle = 'rgba(198, 40, 40, 1)'; // Vermelho
            }
            
            ctx.fillText(text, x, y - 5);
          }
        });
        
        ctx.restore();
      }
    };
    
    // ConfiguraÃ§Ã£o do grÃ¡fico
    const ctx = document.getElementById('subcategoriesChart');
    if (ctx) {
      new Chart(ctx.getContext('2d'), {
        type: 'bar',
        plugins: [percentageLabelPlugin],
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Gasto',
              data: spentData,
              backgroundColor: spentColors,
              borderColor: spentBorderColors,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + value.toFixed(2);
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: {
                  size: 10
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const index = context.dataIndex;
                  const spent = spentData[index];
                  const budget = budgetData[index];
                  const percentage = percentages[index];
                  
                  const lines = [];
                  lines.push('Gasto: R$ ' + spent.toFixed(2));
                  
                  if (budget > 0) {
                    lines.push('OrÃ§ado: R$ ' + budget.toFixed(2));
                    const difference = spent - budget;
                    if (difference > 0) {
                      lines.push('DiferenÃ§a: +R$ ' + difference.toFixed(2) + ' (acima do orÃ§ado)');
                    } else if (difference < 0) {
                      lines.push('DiferenÃ§a: R$ ' + Math.abs(difference).toFixed(2) + ' (abaixo do orÃ§ado)');
                    } else {
                      lines.push('DiferenÃ§a: R$ 0,00 (exatamente no orÃ§ado)');
                    }
                    lines.push('Porcentagem: ' + percentage.toFixed(1) + '%');
                  } else {
                    lines.push('OrÃ§ado: R$ 0,00 (sem orÃ§amento definido)');
                    lines.push('DiferenÃ§a: R$ ' + spent.toFixed(2) + ' (sem referÃªncia)');
                    lines.push('Porcentagem: N/A');
                  }
                  
                  return lines;
                }
              }
            }
          }
        }
      });
    }
  }
</script>
{% endblock %}

