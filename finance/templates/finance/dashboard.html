{% extends "finance/base.html" %}
{% load static %}

{% block content %}
<h1>Dashboard</h1>

<!-- Filtros de PerÃ­odo e Toggle -->
<div style="background-color: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ddd;">
  <form method="get" action="" id="dashboardForm">
    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; justify-content: space-between;">
      <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
        <div>
          <label for="id_year" style="display: block; font-weight: 600; margin-bottom: 5px;">Ano:</label>
          <input type="number" id="id_year" name="year" value="{{ year }}" min="2020" max="2100" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
        </div>
        <div id="monthSelector" style="{% if view_mode == 'annual' %}display: none;{% endif %}">
          <label for="id_month" style="display: block; font-weight: 600; margin-bottom: 5px;">MÃªs:</label>
          <select id="id_month" name="month" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            <option value="1" {% if month == 1 %}selected{% endif %}>Janeiro</option>
            <option value="2" {% if month == 2 %}selected{% endif %}>Fevereiro</option>
            <option value="3" {% if month == 3 %}selected{% endif %}>MarÃ§o</option>
            <option value="4" {% if month == 4 %}selected{% endif %}>Abril</option>
            <option value="5" {% if month == 5 %}selected{% endif %}>Maio</option>
            <option value="6" {% if month == 6 %}selected{% endif %}>Junho</option>
            <option value="7" {% if month == 7 %}selected{% endif %}>Julho</option>
            <option value="8" {% if month == 8 %}selected{% endif %}>Agosto</option>
            <option value="9" {% if month == 9 %}selected{% endif %}>Setembro</option>
            <option value="10" {% if month == 10 %}selected{% endif %}>Outubro</option>
            <option value="11" {% if month == 11 %}selected{% endif %}>Novembro</option>
            <option value="12" {% if month == 12 %}selected{% endif %}>Dezembro</option>
          </select>
        </div>
        <div>
          <button type="submit" style="padding: 6px 12px; font-size: 14px;">Aplicar</button>
        </div>
      </div>
      
      <!-- Toggle de VisualizaÃ§Ã£o -->
      <div style="display: flex; align-items: flex-end; gap: 8px;">
        <label style="display: flex; flex-direction: column; gap: 4px; cursor: pointer;">
          <span style="font-weight: 600; font-size: 12px; color: #555;">VisualizaÃ§Ã£o:</span>
          <div class="view-toggle-container">
            <input type="hidden" name="view_mode" id="view_mode_input" value="{{ view_mode|default:'monthly' }}">
            <div class="view-toggle-switch {% if view_mode == 'annual' %}active-annual{% else %}active-monthly{% endif %}" id="viewToggle">
              <span class="toggle-label monthly-label {% if view_mode != 'annual' %}active{% endif %}">Mensal</span>
              <span class="toggle-slider"></span>
              <span class="toggle-label annual-label {% if view_mode == 'annual' %}active{% endif %}">Anual</span>
            </div>
          </div>
        </label>
      </div>
    </div>
  </form>
</div>

<style>
  .dashboard-grid {
    display: grid;
    grid-template-columns: 2.25fr 2.25fr 2fr;
    gap: 20px;
    margin-bottom: 30px;
  }

  @media (max-width: 1200px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }
  }

  .dashboard-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .dashboard-card h2 {
    margin-top: 0;
    font-size: 18px;
    color: #283593;
    border-bottom: 2px solid #e8eaf6;
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  .metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .metric:last-child {
    border-bottom: none;
  }

  .metric-label {
    font-weight: 600;
    color: #555;
  }

  .metric-value {
    font-size: 18px;
    font-weight: 700;
  }

  .metric-value.positive {
    color: #2e7d32;
  }

  .metric-value.negative {
    color: #c62828;
  }

  .metric-value.neutral {
    color: #283593;
  }

  .recent-transactions {
    margin-top: 10px;
  }

  .transaction-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
  }

  .transaction-item:last-child {
    border-bottom: none;
  }

  .invoice-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .invoice-item:last-child {
    border-bottom: none;
  }

  .invoice-card {
    font-weight: 600;
  }

  .invoice-amount {
    font-size: 16px;
    font-weight: 700;
    color: #c62828;
  }

  .no-data {
    color: #999;
    font-style: italic;
    text-align: center;
    padding: 20px;
  }

  #id_month {
    height: 30px;
  }
  
  /* Estilos para o Toggle de VisualizaÃ§Ã£o */
  .view-toggle-container {
    position: relative;
  }
  
  .view-toggle-switch {
    position: relative;
    display: flex;
    align-items: center;
    width: 110px;
    height: 26px;
    background-color: #e0e0e0;
    border-radius: 13px;
    padding: 1px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  
  .view-toggle-switch.active-monthly {
    background-color: #4CAF50;
  }
  
  .view-toggle-switch.active-annual {
    background-color: #2196F3;
  }
  
  .toggle-slider {
    position: absolute;
    width: 52px;
    height: 24px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease;
    z-index: 1;
  }
  
  .view-toggle-switch.active-monthly .toggle-slider {
    transform: translateX(0);
  }
  
  .view-toggle-switch.active-annual .toggle-slider {
    transform: translateX(56px);
  }
  
  .toggle-label {
    position: relative;
    flex: 1;
    text-align: center;
    font-weight: 500;
    font-size: 11px;
    z-index: 2;
    transition: color 0.3s ease;
    color: #666;
  }
  
  .toggle-label.active {
    color: #000000 !important;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }
  
  .toggle-label.monthly-label {
    padding-left: 2px;
  }
  
  .toggle-label.annual-label {
    padding-right: 2px;
  }
  
  .view-toggle-switch:hover {
    opacity: 0.9;
  }
</style>

{% if view_mode == 'annual' %}
  <!-- ========== VISUALIZAÃ‡ÃƒO ANUAL ========== -->
  
  <!-- Resumo Financeiro Anual -->
  <div class="dashboard-grid">
    <div class="dashboard-card">
      <h2>ðŸ’° Resumo Financeiro Anual</h2>
      <div class="metric">
        <span class="metric-label">Saldo Atual</span>
        <span class="metric-value neutral">R$ {{ total_balance|floatformat:2 }}</span>
      </div>
      <div class="metric">
        <span class="metric-label">Receitas do Ano</span>
        <span class="metric-value positive">R$ {{ year_income|floatformat:2 }}</span>
      </div>
      <div class="metric">
        <span class="metric-label">Despesas do Ano</span>
        <span class="metric-value negative">- R$ {{ year_expenses|floatformat:2 }}</span>
      </div>
      <div class="metric">
        <span class="metric-label">Saldo do Ano</span>
        <span class="metric-value {% if year_balance >= 0 %}positive{% else %}negative{% endif %}">
          R$ {{ year_balance|floatformat:2 }}
        </span>
      </div>
    </div>

    <div class="dashboard-card">
      <h2>ðŸ“Š MÃ©dias Mensais</h2>
      <div class="metric">
        <span class="metric-label">MÃ©dia Mensal de Receitas</span>
        <span class="metric-value positive">R$ {{ year_avg_income|floatformat:2 }}</span>
      </div>
      <div class="metric">
        <span class="metric-label">MÃ©dia Mensal de Despesas</span>
        <span class="metric-value negative">- R$ {{ year_avg_expenses|floatformat:2 }}</span>
      </div>
      <div class="metric">
        <span class="metric-label">Total de TransaÃ§Ãµes</span>
        <span class="metric-value neutral">{{ year_transactions_count }}</span>
      </div>
      <div class="metric">
        <span class="metric-label">Saldo Planejado (Ano)</span>
        <span class="metric-value {% if budget_diff >= 0 %}positive{% else %}negative{% endif %}">
          R$ {{ budget_diff|floatformat:2 }}
        </span>
      </div>
    </div>

    <div class="dashboard-card">
      <h2>ðŸ“ˆ OrÃ§amentos Anuais</h2>
      <div class="metric">
        <span class="metric-label">Receitas OrÃ§adas (Ano)</span>
        <span class="metric-value positive">R$ {{ income_budget|floatformat:2 }}</span>
      </div>
      <div class="metric">
        <span class="metric-label">Despesas OrÃ§adas (Ano)</span>
        <span class="metric-value negative">- R$ {{ expense_budget|floatformat:2 }}</span>
      </div>
      <div class="metric">
        <span class="metric-label">Receitas Realizadas vs OrÃ§adas</span>
        <span class="metric-value {% if income_budget > 0 and year_income <= income_budget %}positive{% else %}negative{% endif %}">
          {% if income_budget > 0 %}{{ year_income|floatformat:0 }} / {{ income_budget|floatformat:0 }}{% else %}N/A{% endif %}
        </span>
      </div>
      <div class="metric">
        <span class="metric-label">Despesas Realizadas vs OrÃ§adas</span>
        <span class="metric-value {% if expense_budget > 0 and year_expenses <= expense_budget %}positive{% else %}negative{% endif %}">
          {% if expense_budget > 0 %}{{ year_expenses|floatformat:0 }} / {{ expense_budget|floatformat:0 }}{% else %}N/A{% endif %}
        </span>
      </div>
    </div>
  </div>

  <!-- GrÃ¡fico de Receitas/Despesas por MÃªs -->
  <div class="dashboard-card" style="margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
      <h2 id="monthlyChartTitle" style="margin: 0;">ðŸ“Š Receitas e Despesas por MÃªs ({{ year }})</h2>
      <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <!-- Toggle Recebido / OrÃ§ado -->
        <div id="chartDataToggle" role="button" tabindex="0" style="display: flex; align-items: center; background-color: #e8e8e8; border: 1px solid #bbb; border-radius: 6px; padding: 2px; cursor: pointer; user-select: none;">
          <span id="chartDataToggleRecebido" style="padding: 4px 10px; font-size: 13px; font-weight: 600; border-radius: 4px; background-color: #1976d2; color: white;">Recebido</span>
          <span id="chartDataToggleOrcado" style="padding: 4px 10px; font-size: 13px; font-weight: 500; border-radius: 4px; color: #666;">OrÃ§ado</span>
        </div>
        <div style="position: relative; display: inline-block;">
        <button type="button" id="filterCategoryBtn" style="padding: 6px 12px; background-color: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #000;">
          <span id="filterCategoryText">Filtrar por categoria/subcategoria</span>
          <span style="font-size: 10px;">â–¼</span>
        </button>
        <div id="filterCategoryDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; min-width: 280px; max-height: 400px; overflow-y: auto; padding: 8px;">
          <div style="padding: 8px; border-bottom: 1px solid #eee; font-weight: 600; font-size: 14px;">Selecione categoria ou subcategoria:</div>
          <div id="filterCategoryList" style="padding: 4px 0;">
            <!-- SerÃ¡ preenchido via JavaScript -->
          </div>
        </div>
      </div>
    </div>
    <canvas id="monthlyIncomeExpensesChart" style="max-height: 400px;"></canvas>
  </div>

  <!-- GrÃ¡fico de Gastos por Subcategoria (Anual) -->
  <div class="dashboard-card" style="margin-bottom: 30px;">
    <h2>ðŸ“Š Gasto Total por Subcategoria ({{ year }})</h2>
    <canvas id="annualSubcategoriesChart" style="max-height: 500px;"></canvas>
  </div>

{% else %}
  <!-- ========== VISUALIZAÃ‡ÃƒO MENSUAL (ORIGINAL) ========== -->
  
  <!-- Resumo Financeiro -->
<div class="dashboard-grid">
  <div class="dashboard-card">
    <h2>ðŸ’° Resumo Financeiro</h2>
    <div class="metric">
      <span class="metric-label">Saldo Atual</span>
      <span class="metric-value neutral">R$ {{ total_balance|floatformat:2 }}</span>
    </div>
    <div class="metric">
      <span class="metric-label">Receitas do MÃªs</span>
      <span class="metric-value positive">R$ {{ month_income|floatformat:2 }}</span>
    </div>
    <div class="metric">
      <span class="metric-label">Despesas do MÃªs</span>
      <span class="metric-value negative">- R$ {{ month_expenses|floatformat:2 }}</span>
    </div>
    <div class="metric">
      <span class="metric-label">Saldo do MÃªs</span>
      <span class="metric-value {% if month_balance >= 0 %}positive{% else %}negative{% endif %}">
        R$ {{ month_balance|floatformat:2 }}
      </span>
    </div>
  </div>

  <div class="dashboard-card">
    <h2>ðŸ“Š Planejamento</h2>
    <div class="metric">
      <span class="metric-label">Saldo Projetado</span>
      <span class="metric-value {% if projected_balance >= 0 %}positive{% else %}negative{% endif %}">
        R$ {{ projected_balance|floatformat:2 }}
      </span>
    </div>
    <div class="metric">
      <span class="metric-label">Receitas Planejadas</span>
      <span class="metric-value {% if income_planned_percent <= 100 %}positive{% else %}negative{% endif %}">
        R$ {{ income_budget|floatformat:2 }} <span style="font-size: 14px; font-weight: 500;">({{ income_planned_percent|floatformat:1 }}%)</span>
      </span>
    </div>
    <div class="metric">
      <span class="metric-label">Despesas Planejadas</span>
      <span class="metric-value negative">
        - R$ {{ expense_budget|floatformat:2 }} <span style="font-size: 14px; font-weight: 500;">({{ expense_planned_percent|floatformat:1 }}%)</span>
      </span>
    </div>
    <div class="metric">
      <span class="metric-label">Saldo Planejado</span>
      <span class="metric-value {% if budget_diff >= 0 %}positive{% else %}negative{% endif %}">
        R$ {{ budget_diff|floatformat:2 }}
      </span>
    </div>
  </div>

  <div class="dashboard-card">
    <h2>ðŸ’³ Faturas dos CartÃµes</h2>
    {% if all_invoices %}
      {% for invoice in all_invoices %}
        <div class="invoice-item">
          <div>
            <div class="invoice-card">{{ invoice.card_name }}</div>
            <div style="font-size: 12px; color: #666;">
              {{ invoice.month }}/{{ invoice.year }}
              {% if invoice.is_paid %}
                <span style="color: #4caf50; font-weight: 600; margin-left: 5px;">âœ“ Paga</span>
              {% else %}
                <span style="color: #ff9800; font-weight: 600; margin-left: 5px;">âš  Pendente</span>
              {% endif %}
            </div>
          </div>
          <div class="invoice-amount" style="{% if invoice.is_paid %}color: #666;{% endif %}">R$ {{ invoice.total|floatformat:2 }}</div>
        </div>
      {% endfor %}
    {% else %}
      <div class="no-data">Nenhuma fatura no perÃ­odo</div>
    {% endif %}
  </div>
</div>

<!-- GrÃ¡fico de Subcategorias -->
<div class="dashboard-card" style="margin-bottom: 30px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h2 style="margin: 0;">ðŸ“Š Gasto vs OrÃ§ado por Subcategoria</h2>
    <div style="position: relative; display: inline-block;">
      <button type="button" id="excludeSubcategoriesBtn" style="padding: 6px 12px; background-color: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #000;">
        Excluir subcategorias
        <span id="excludeSubcategoriesCount" style="background-color: #1976d2; color: white; border-radius: 12px; padding: 2px 6px; font-size: 12px; min-width: 18px; text-align: center; display: none;">0</span>
        <span style="font-size: 10px;">â–¼</span>
      </button>
      <div id="excludeSubcategoriesDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; min-width: 250px; max-height: 400px; overflow-y: auto; padding: 8px;">
        <div style="padding: 8px; border-bottom: 1px solid #eee; font-weight: 600; font-size: 14px;">Selecione subcategorias para excluir:</div>
        <div style="padding: 8px; border-top: 1px solid #eee; display: flex; gap: 8px; justify-content: flex-end;">
          <button type="button" id="clearExclusionsBtn" style="padding: 4px 12px; background-color: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; cursor: pointer; color: #000;">Limpar</button>
        </div>
        <div id="excludeSubcategoriesList" style="padding: 4px 0;">
          <!-- SerÃ¡ preenchido via JavaScript -->
        </div>
      </div>
    </div>
  </div>
  <canvas id="subcategoriesChart" style="max-height: 500px;"></canvas>
  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; font-size: 12px; color: #666;">
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 30px; height: 2px; border-top: 2px dashed rgba(46, 125, 50, 0.8);"></div>
      <span>Valor OrÃ§ado (referÃªncia)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 20px; height: 12px; background-color: rgba(33, 150, 243, 0.7); border: 2px solid rgba(33, 150, 243, 1);"></div>
      <span>&lt; 85% do orÃ§ado</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 20px; height: 12px; background-color: rgba(255, 152, 0, 0.7); border: 2px solid rgba(255, 152, 0, 1);"></div>
      <span>85% - 99% do orÃ§ado</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 20px; height: 12px; background-color: rgba(49, 248, 59, 0.7); border: 2px solid rgba(46, 125, 50, 1);"></div>
      <span>100% do orÃ§ado</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <div style="width: 20px; height: 12px; background-color: rgba(198, 40, 40, 0.7); border: 2px solid rgba(198, 40, 40, 1);"></div>
      <span>&gt; 100% do orÃ§ado ou sem orÃ§amento</span>
    </div>
  </div>
</div>

<!-- Ãšltimas TransaÃ§Ãµes -->
<div class="dashboard-card">
  <h2>ðŸ•’ Ãšltimas TransaÃ§Ãµes</h2>
  {% if recent_transactions %}
    <div class="recent-transactions">
      {% for t in recent_transactions %}
        <div class="transaction-item">
          <div>
            <span style="font-weight: 600;">{{ t.date|date:"d/m/Y" }}</span> - 
            {{ t.description|default:"Sem descriÃ§Ã£o" }}
            <span style="color: #666; font-size: 12px;">({{ t.subcategory.category.name }})</span>
          </div>
          <div style="font-weight: 700; {% if t.type == 'IN' %}color: #2e7d32;{% else %}color: #c62828;{% endif %}">
            {% if t.type == 'EX' %}-{% endif %}R$ {{ t.amount|floatformat:2 }}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="no-data">Nenhuma transaÃ§Ã£o registrada</div>
  {% endif %}
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // ========== TOGGLE MENSAL/ANUAL ==========
  document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('viewToggle');
    const viewModeInput = document.getElementById('view_mode_input');
    const monthSelector = document.getElementById('monthSelector');
    
    if (toggle) {
      toggle.addEventListener('click', function() {
        const currentMode = viewModeInput.value;
        const newMode = currentMode === 'monthly' ? 'annual' : 'monthly';
        viewModeInput.value = newMode;
        
        // Atualizar classes CSS do toggle
        const monthlyLabel = toggle.querySelector('.monthly-label');
        const annualLabel = toggle.querySelector('.annual-label');
        
        if (newMode === 'annual') {
          toggle.classList.remove('active-monthly');
          toggle.classList.add('active-annual');
          if (monthlyLabel) monthlyLabel.classList.remove('active');
          if (annualLabel) annualLabel.classList.add('active');
          if (monthSelector) monthSelector.style.display = 'none';
        } else {
          toggle.classList.remove('active-annual');
          toggle.classList.add('active-monthly');
          if (annualLabel) annualLabel.classList.remove('active');
          if (monthlyLabel) monthlyLabel.classList.add('active');
          if (monthSelector) monthSelector.style.display = 'block';
        }
        
        // Submeter o formulÃ¡rio
        document.getElementById('dashboardForm').submit();
      });
    }
  });

{% if view_mode == 'annual' %}
  // ========== GRÃFICOS PARA VISUALIZAÃ‡ÃƒO ANUAL ==========
  
  // ========== GRÃFICO DE RECEITAS/DESPESAS POR MÃŠS COM FILTRO ==========
  const originalMonthlyData = {{ monthly_income_expenses|safe }};
  const originalMonthlyDataBudget = {{ monthly_income_expenses_budget|safe }};
  const monthlyDataByCategory = {{ monthly_data_by_category|safe }};
  const monthlyDataByCategoryBudget = {{ monthly_data_by_category_budget|safe }};
  const monthlyDataBySubcategory = {{ monthly_data_by_subcategory|safe }};
  const monthlyDataBySubcategoryBudget = {{ monthly_data_by_subcategory_budget|safe }};
  const categoriesForFilter = {{ categories_for_filter|safe }};
  const subcategoriesForFilter = {{ subcategories_for_filter|safe }};
  const currentYear = {{ year }};
  const originalChartTitle = 'ðŸ“Š Receitas e Despesas por MÃªs (' + currentYear + ')';
  let monthlyChart = null;
  let currentFilter = null; // 'category_X', 'subcategory_X', ou null
  let currentFilterName = null; // Nome da categoria/subcategoria selecionada
  let chartDataMode = 'recebido'; // 'recebido' ou 'orcado'
  
  // FunÃ§Ã£o para criar/atualizar o grÃ¡fico mensal
  function updateMonthlyChart(data) {
    if (!data || data.length === 0) return;
    
    const monthlyCtx = document.getElementById('monthlyIncomeExpensesChart');
    if (!monthlyCtx) return;
    
    const monthLabels = data.map(item => item.month);
    const incomeData = data.map(item => item.income);
    const expensesData = data.map(item => item.expenses);
    const isOrcado = chartDataMode === 'orcado';
    const incomeLabel = isOrcado ? 'Receitas (OrÃ§ado)' : 'Receitas';
    const expensesLabel = isOrcado ? 'Despesas (OrÃ§ado)' : 'Despesas';
    
    // Destruir grÃ¡fico existente se houver
    if (monthlyChart) {
      monthlyChart.destroy();
    }
    
    monthlyChart = new Chart(monthlyCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: monthLabels,
        datasets: [
          {
            label: incomeLabel,
            data: incomeData,
            borderColor: 'rgba(46, 125, 50, 1)',
            backgroundColor: 'rgba(46, 125, 50, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          },
          {
            label: expensesLabel,
            data: expensesData,
            borderColor: 'rgba(198, 40, 40, 1)',
            backgroundColor: 'rgba(198, 40, 40, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': R$ ' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toFixed(0);
              }
            }
          }
        }
      }
    });
  }
  
  // FunÃ§Ã£o para popular o dropdown de filtro
  function populateCategoryFilter() {
    const container = document.getElementById('filterCategoryList');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Adicionar opÃ§Ã£o "Todas" (sem filtro)
    const allOption = document.createElement('label');
    allOption.style.display = 'block';
    allOption.style.padding = '6px 8px';
    allOption.style.cursor = 'pointer';
    allOption.style.fontSize = '14px';
    allOption.style.userSelect = 'none';
    
    allOption.onmouseover = function() {
      this.style.backgroundColor = '#f5f5f5';
    };
    allOption.onmouseout = function() {
      this.style.backgroundColor = 'transparent';
    };
    
    const allRadio = document.createElement('input');
    allRadio.type = 'radio';
    allRadio.name = 'categoryFilter';
    allRadio.value = '';
    allRadio.style.marginRight = '8px';
    allRadio.style.cursor = 'pointer';
    if (!currentFilter) {
      allRadio.checked = true;
    }
    allRadio.addEventListener('change', function() {
      if (this.checked) {
        applyFilter(null, null);
        document.getElementById('filterCategoryText').textContent = 'Filtrar por categoria/subcategoria';
        toggleFilterDropdown();
      }
    });
    
    const allSpan = document.createElement('span');
    allSpan.textContent = 'Todas (sem filtro)';
    allSpan.style.fontWeight = '600';
    
    allOption.appendChild(allRadio);
    allOption.appendChild(allSpan);
    container.appendChild(allOption);
    
    // Separador
    const separator = document.createElement('div');
    separator.style.height = '1px';
    separator.style.backgroundColor = '#e0e0e0';
    separator.style.margin = '8px 0';
    container.appendChild(separator);
    
    // Agrupar categorias por tipo (Receitas primeiro, depois Despesas)
    const incomeCategories = categoriesForFilter.filter(c => c.is_income);
    const expenseCategories = categoriesForFilter.filter(c => !c.is_income);
    
    // Adicionar categorias de Receitas
    if (incomeCategories.length > 0) {
      const incomeHeader = document.createElement('div');
      incomeHeader.style.padding = '6px 8px';
      incomeHeader.style.fontWeight = '600';
      incomeHeader.style.fontSize = '12px';
      incomeHeader.style.color = '#666';
      incomeHeader.style.backgroundColor = '#f9f9f9';
      incomeHeader.textContent = 'Categorias - Receitas';
      container.appendChild(incomeHeader);
      
      incomeCategories.forEach(cat => {
        const label = createFilterOption('category_' + cat.id, cat.name, 'category');
        container.appendChild(label);
      });
    }
    
    // Adicionar categorias de Despesas
    if (expenseCategories.length > 0) {
      const expenseHeader = document.createElement('div');
      expenseHeader.style.padding = '6px 8px';
      expenseHeader.style.fontWeight = '600';
      expenseHeader.style.fontSize = '12px';
      expenseHeader.style.color = '#666';
      expenseHeader.style.backgroundColor = '#f9f9f9';
      expenseHeader.style.marginTop = '8px';
      expenseHeader.textContent = 'Categorias - Despesas';
      container.appendChild(expenseHeader);
      
      expenseCategories.forEach(cat => {
        const label = createFilterOption('category_' + cat.id, cat.name, 'category');
        container.appendChild(label);
      });
    }
    
    // Separador para subcategorias
    if (subcategoriesForFilter.length > 0) {
      const subcatSeparator = document.createElement('div');
      subcatSeparator.style.height = '1px';
      subcatSeparator.style.backgroundColor = '#e0e0e0';
      subcatSeparator.style.margin = '12px 0 8px 0';
      container.appendChild(subcatSeparator);
      
      const subcatHeader = document.createElement('div');
      subcatHeader.style.padding = '6px 8px';
      subcatHeader.style.fontWeight = '600';
      subcatHeader.style.fontSize = '12px';
      subcatHeader.style.color = '#666';
      subcatHeader.style.backgroundColor = '#f9f9f9';
      subcatHeader.textContent = 'Subcategorias';
      container.appendChild(subcatHeader);
      
      // Agrupar subcategorias por categoria
      const subcatsByCategory = {};
      subcategoriesForFilter.forEach(subcat => {
        const catKey = subcat.category_name;
        if (!subcatsByCategory[catKey]) {
          subcatsByCategory[catKey] = [];
        }
        subcatsByCategory[catKey].push(subcat);
      });
      
      Object.keys(subcatsByCategory).sort().forEach(catName => {
        subcatsByCategory[catName].forEach(subcat => {
          const label = createFilterOption('subcategory_' + subcat.id, subcat.full_name, 'subcategory');
          container.appendChild(label);
        });
      });
    }
  }
  
  // FunÃ§Ã£o auxiliar para criar opÃ§Ã£o de filtro
  function createFilterOption(value, text, type) {
    const label = document.createElement('label');
    label.style.display = 'block';
    label.style.padding = '6px 8px';
    label.style.paddingLeft = type === 'subcategory' ? '20px' : '8px';
    label.style.cursor = 'pointer';
    label.style.fontSize = '14px';
    label.style.userSelect = 'none';
    
    label.onmouseover = function() {
      this.style.backgroundColor = '#f5f5f5';
    };
    label.onmouseout = function() {
      this.style.backgroundColor = 'transparent';
    };
    
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'categoryFilter';
    radio.value = value;
    radio.style.marginRight = '8px';
    radio.style.cursor = 'pointer';
    if (currentFilter === value) {
      radio.checked = true;
    }
    radio.addEventListener('change', function() {
      if (this.checked) {
        currentFilter = value;
        currentFilterName = text;
        applyFilter(value, text);
        document.getElementById('filterCategoryText').textContent = text.length > 30 ? text.substring(0, 30) + '...' : text;
        toggleFilterDropdown();
      }
    });
    
    const span = document.createElement('span');
    span.textContent = text;
    
    label.appendChild(radio);
    label.appendChild(span);
    return label;
  }
  
  // FunÃ§Ã£o para atualizar o tÃ­tulo do grÃ¡fico
  function updateChartTitle(filterName) {
    const titleElement = document.getElementById('monthlyChartTitle');
    if (!titleElement) return;
    
    const modeSuffix = chartDataMode === 'orcado' ? ' (OrÃ§ado)' : '';
    const baseTitle = 'ðŸ“Š Receitas e Despesas por MÃªs (' + currentYear + ')' + modeSuffix;
    
    if (filterName) {
      titleElement.textContent = baseTitle + ' - Filtrado: ' + filterName;
    } else {
      titleElement.textContent = baseTitle;
    }
  }
  
  // FunÃ§Ã£o para obter os dados atuais conforme modo (recebido/orÃ§ado) e filtro
  function getCurrentChartData() {
    const baseData = chartDataMode === 'recebido' ? originalMonthlyData : originalMonthlyDataBudget;
    const categoryData = chartDataMode === 'recebido' ? monthlyDataByCategory : monthlyDataByCategoryBudget;
    const subcategoryData = chartDataMode === 'recebido' ? monthlyDataBySubcategory : monthlyDataBySubcategoryBudget;
    
    if (!currentFilter) return baseData;
    if (currentFilter.startsWith('category_')) return categoryData[currentFilter] || baseData;
    if (currentFilter.startsWith('subcategory_')) return subcategoryData[currentFilter] || baseData;
    return baseData;
  }
  
  // FunÃ§Ã£o para aplicar filtro
  function applyFilter(filterKey, filterName) {
    currentFilter = filterKey;
    currentFilterName = filterName;
    const dataToUse = getCurrentChartData();
    updateMonthlyChart(dataToUse);
    updateChartTitle(filterName || null);
  }
  
  // FunÃ§Ã£o para abrir/fechar dropdown
  function toggleFilterDropdown() {
    const dropdown = document.getElementById('filterCategoryDropdown');
    if (dropdown) {
      const isVisible = dropdown.style.display !== 'none';
      dropdown.style.display = isVisible ? 'none' : 'block';
    }
  }
  
  // FunÃ§Ã£o para alternar entre Recebido e OrÃ§ado
  function toggleChartDataMode() {
    chartDataMode = chartDataMode === 'recebido' ? 'orcado' : 'recebido';
    
    const recebidoEl = document.getElementById('chartDataToggleRecebido');
    const orcadoEl = document.getElementById('chartDataToggleOrcado');
    if (recebidoEl && orcadoEl) {
      if (chartDataMode === 'recebido') {
        recebidoEl.style.backgroundColor = '#1976d2';
        recebidoEl.style.color = 'white';
        recebidoEl.style.fontWeight = '600';
        orcadoEl.style.backgroundColor = 'transparent';
        orcadoEl.style.color = '#666';
        orcadoEl.style.fontWeight = '500';
      } else {
        recebidoEl.style.backgroundColor = 'transparent';
        recebidoEl.style.color = '#666';
        recebidoEl.style.fontWeight = '500';
        orcadoEl.style.backgroundColor = '#1976d2';
        orcadoEl.style.color = 'white';
        orcadoEl.style.fontWeight = '600';
      }
    }
    
    const dataToUse = getCurrentChartData();
    updateMonthlyChart(dataToUse);
    updateChartTitle(currentFilterName || null);
  }
  
  // Inicializar grÃ¡fico e filtro (mostrar se houver dados recebidos OU orÃ§ados)
  const hasData = (originalMonthlyData && originalMonthlyData.length > 0) ||
    (originalMonthlyDataBudget && originalMonthlyDataBudget.length > 0);
  if (hasData) {
    populateCategoryFilter();
    updateMonthlyChart(getCurrentChartData());
    
    // Event listener para o toggle Recebido/OrÃ§ado
    const chartDataToggle = document.getElementById('chartDataToggle');
    if (chartDataToggle) {
      chartDataToggle.addEventListener('click', toggleChartDataMode);
      chartDataToggle.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleChartDataMode();
        }
      });
    }
    
    // Event listener para o botÃ£o do dropdown
    const filterBtn = document.getElementById('filterCategoryBtn');
    if (filterBtn) {
      filterBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleFilterDropdown();
      });
    }
    
    // Fechar dropdown quando clicar fora
    document.addEventListener('click', function(event) {
      const btn = document.getElementById('filterCategoryBtn');
      const dropdown = document.getElementById('filterCategoryDropdown');
      
      if (btn && dropdown && !btn.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.style.display = 'none';
      }
    });
  }
  
  // GrÃ¡fico de Gastos por Subcategoria (Anual)
  const annualSubcategoriesData = {{ subcategories_chart_data|safe }};
  if (annualSubcategoriesData && annualSubcategoriesData.length > 0) {
    const annualSubCtx = document.getElementById('annualSubcategoriesChart');
    if (annualSubCtx) {
      const labels = annualSubcategoriesData.map(item => item.name);
      const spentData = annualSubcategoriesData.map(item => item.spent);
      
      // Cores para o grÃ¡fico
      const colors = [
        'rgba(33, 150, 243, 0.8)',
        'rgba(255, 152, 0, 0.8)',
        'rgba(76, 175, 80, 0.8)',
        'rgba(156, 39, 176, 0.8)',
        'rgba(244, 67, 54, 0.8)',
        'rgba(0, 188, 212, 0.8)',
        'rgba(255, 193, 7, 0.8)',
        'rgba(233, 30, 99, 0.8)',
        'rgba(63, 81, 181, 0.8)',
        'rgba(255, 87, 34, 0.8)',
      ];
      
      const backgroundColors = [];
      for (let i = 0; i < spentData.length; i++) {
        backgroundColors.push(colors[i % colors.length]);
      }
      
      new Chart(annualSubCtx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Gasto Total (Ano)',
            data: spentData,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Gasto Total: R$ ' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + value.toFixed(0);
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });
    }
  }

{% else %}
  // ========== GRÃFICOS PARA VISUALIZAÃ‡ÃƒO MENSUAL (ORIGINAL) ==========
  // Dados do grÃ¡fico originais
  const originalChartData = {{ subcategories_chart_data|safe }};
  let chart = null; // VariÃ¡vel global para armazenar a instÃ¢ncia do grÃ¡fico
  let currentBudgetData = []; // VariÃ¡vel global para dados orÃ§ados atuais
  let currentPercentages = []; // VariÃ¡vel global para porcentagens atuais
  
  // FunÃ§Ã£o para filtrar dados excluindo subcategorias selecionadas
  function filterData(data, excludedSubcategories) {
    if (!data || data.length === 0) return [];
    if (!excludedSubcategories || excludedSubcategories.length === 0) return data;
    
    return data.filter(item => {
      const itemName = item.name ? item.name.toLowerCase().trim() : '';
      return !excludedSubcategories.some(excluded => {
        const excludedName = excluded.toLowerCase().trim();
        return itemName === excludedName;
      });
    });
  }
  
  // FunÃ§Ã£o para popular o dropdown com checkboxes das subcategorias disponÃ­veis
  function populateSubcategoriesDropdown() {
    const container = document.getElementById('excludeSubcategoriesList');
    if (!container || !originalChartData || originalChartData.length === 0) return;
    
    // Limpar conteÃºdo existente
    container.innerHTML = '';
    
    // Adicionar cada subcategoria como um checkbox
    originalChartData.forEach(item => {
      if (item.name) {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.padding = '6px 8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.userSelect = 'none';
        
        label.onmouseover = function() {
          this.style.backgroundColor = '#f5f5f5';
        };
        label.onmouseout = function() {
          this.style.backgroundColor = 'transparent';
        };
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = item.name;
        checkbox.style.marginRight = '8px';
        checkbox.style.cursor = 'pointer';
        checkbox.addEventListener('change', function() {
          updateChart();
          updateExclusionsCount();
        });
        
        const span = document.createElement('span');
        span.textContent = item.name;
        
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      }
    });
  }
  
  // FunÃ§Ã£o para obter subcategorias selecionadas (excluir)
  function getExcludedSubcategories() {
    const checkboxes = document.querySelectorAll('#excludeSubcategoriesList input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
  }
  
  // FunÃ§Ã£o para atualizar o contador de exclusÃµes
  function updateExclusionsCount() {
    const count = getExcludedSubcategories().length;
    const countElement = document.getElementById('excludeSubcategoriesCount');
    if (countElement) {
      if (count > 0) {
        countElement.textContent = count;
        countElement.style.display = 'inline-block';
      } else {
        countElement.style.display = 'none';
      }
    }
  }
  
  // FunÃ§Ã£o para abrir/fechar dropdown
  function toggleExcludeDropdown() {
    const dropdown = document.getElementById('excludeSubcategoriesDropdown');
    if (dropdown) {
      const isVisible = dropdown.style.display !== 'none';
      dropdown.style.display = isVisible ? 'none' : 'block';
    }
  }
  
  // Plugin customizado para adicionar porcentagens no topo das barras de gasto
  const percentageLabelPlugin = {
    id: 'percentageLabel',
    afterDatasetsDraw: function(chart) {
      const ctx = chart.ctx;
      const meta = chart.getDatasetMeta(0); // Dataset de "Gasto"
      const yScale = chart.scales.y;
      
      ctx.save();
      ctx.font = 'bold 11px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      
      meta.data.forEach((bar, index) => {
        const percentage = currentPercentages[index] || 0;
        const budget = currentBudgetData[index] || 0;
        const spent = chart.data.datasets[0].data[index] || 0;
        
        // Desenhar linha de referÃªncia horizontal para o valor orÃ§ado
        if (budget > 0) {
          const budgetY = yScale.getPixelForValue(budget);
          const barLeft = bar.x - bar.width / 2;
          const barRight = bar.x + bar.width / 2;
          
          // Linha tracejada verde
          ctx.strokeStyle = 'rgba(46, 125, 50, 0.8)';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(barLeft, budgetY);
          ctx.lineTo(barRight, budgetY);
          ctx.stroke();
          ctx.setLineDash([]);
        }
        
        // Adicionar porcentagem no topo da barra de gasto
        if (spent > 0) {
          const x = bar.x;
          const y = bar.y;
          let text;
          
          // Se nÃ£o hÃ¡ orÃ§amento, mostrar "N/A"
          if (budget === 0) {
            text = 'N/A';
          } else {
            text = percentage.toFixed(1) + '%';
          }
          
          // Cor do texto baseada na porcentagem ou se nÃ£o hÃ¡ orÃ§amento
          ctx.font = 'bold 11px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          if (budget === 0 && spent > 0) {
            ctx.fillStyle = 'rgba(198, 40, 40, 1)'; // Vermelho para sem orÃ§amento
          } else if (percentage < 85) {
            ctx.fillStyle = 'rgba(33, 150, 243, 1)'; // Azul
          } else if (percentage < 100) {
            ctx.fillStyle = 'rgba(255, 152, 0, 1)'; // Laranja
          } else if (Math.abs(percentage - 100) < 0.01) {
            ctx.fillStyle = 'rgba(46, 125, 50, 1)'; // Verde (com tolerÃ¢ncia para arredondamentos)
          } else {
            ctx.fillStyle = 'rgba(198, 40, 40, 1)'; // Vermelho
          }
          
          ctx.fillText(text, x, y - 5);
        }
      });
      
      ctx.restore();
    }
  };
  
  // FunÃ§Ã£o para criar/atualizar o grÃ¡fico
  function updateChart() {
    if (!originalChartData || originalChartData.length === 0) return;
    
    // Obter subcategorias selecionadas para exclusÃ£o
    const excludedSubcategories = getExcludedSubcategories();
    
    const chartData = filterData(originalChartData, excludedSubcategories);
    
    if (!chartData || chartData.length === 0) {
      console.warn('Nenhum dado disponÃ­vel apÃ³s filtrar');
      return;
    }
    
    const labels = chartData.map(item => item.name);
    const spentData = chartData.map(item => item.spent);
    const budgetData = chartData.map(item => item.budget);
    
    // Atualizar variÃ¡veis globais para o plugin
    currentBudgetData = budgetData;
    
    // Calcular o valor mÃ¡ximo entre gastos e orÃ§ados para ajustar a escala do eixo Y
    const maxSpent = Math.max(...spentData, 0);
    const maxBudget = Math.max(...budgetData, 0);
    const maxValue = Math.max(maxSpent, maxBudget);
    const yAxisMax = maxValue > 0 ? maxValue * 1.15 : 100; // Adicionar 15% de margem
    
    // Calcular porcentagens e cores para as barras de gasto
    const percentages = [];
    const spentColors = [];
    const spentBorderColors = [];
    
    spentData.forEach((spent, index) => {
      const budget = budgetData[index];
      let percentage = 0;
      
      // Se nÃ£o hÃ¡ orÃ§amento mas hÃ¡ gasto, usar vermelho
      if (budget === 0 && spent > 0) {
        percentage = 101; // Valor maior que 100 para forÃ§ar vermelho
      } else if (budget > 0) {
        percentage = (spent / budget) * 100;
      }
      
      percentages.push(percentage);
      
      // Definir cores baseado na porcentagem
      if (budget === 0 && spent > 0) {
        // Vermelho quando nÃ£o hÃ¡ orÃ§amento mas hÃ¡ gasto
        spentColors.push('rgba(198, 40, 40, 0.7)'); // Vermelho com transparÃªncia
        spentBorderColors.push('rgba(198, 40, 40, 1)'); // Vermelho sÃ³lido
      } else if (percentage < 85) {
        // Azul para < 85%
        spentColors.push('rgba(33, 150, 243, 0.7)'); // Azul com transparÃªncia
        spentBorderColors.push('rgba(33, 150, 243, 1)'); // Azul sÃ³lido
      } else if (percentage < 100) {
        // Laranja para 85% - 99.9%
        spentColors.push('rgba(255, 152, 0, 0.7)'); // Laranja com transparÃªncia
        spentBorderColors.push('rgba(255, 152, 0, 1)'); // Laranja sÃ³lido
      } else if (Math.abs(percentage - 100) < 0.01) {
        // Verde para exatamente 100% (com tolerÃ¢ncia para arredondamentos)
        spentColors.push('rgba(46, 125, 50, 0.7)'); // Verde com transparÃªncia
        spentBorderColors.push('rgba(46, 125, 50, 1)'); // Verde sÃ³lido
      } else {
        // Vermelho para > 100%
        spentColors.push('rgba(198, 40, 40, 0.7)'); // Vermelho com transparÃªncia
        spentBorderColors.push('rgba(198, 40, 40, 1)'); // Vermelho sÃ³lido
      }
    });
    
    // Atualizar variÃ¡vel global de porcentagens
    currentPercentages = percentages;
    
    // Destruir grÃ¡fico existente se houver
    if (chart) {
      chart.destroy();
    }
    
    // ConfiguraÃ§Ã£o do grÃ¡fico
    const ctx = document.getElementById('subcategoriesChart');
    if (ctx) {
      chart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        plugins: [percentageLabelPlugin],
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Gasto',
              data: spentData,
              backgroundColor: spentColors,
              borderColor: spentBorderColors,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              max: yAxisMax,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + value.toFixed(2);
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: {
                  size: 14
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const index = context.dataIndex;
                  const spent = spentData[index];
                  const budget = budgetData[index];
                  const percentage = percentages[index];
                  
                  const lines = [];
                  lines.push('Gasto: R$ ' + spent.toFixed(2));
                  
                  if (budget > 0) {
                    lines.push('OrÃ§ado: R$ ' + budget.toFixed(2));
                    const difference = spent - budget;
                    if (difference > 0) {
                      lines.push('DiferenÃ§a: +R$ ' + difference.toFixed(2) + ' (acima do orÃ§ado)');
                    } else if (difference < 0) {
                      lines.push('DiferenÃ§a: R$ ' + Math.abs(difference).toFixed(2) + ' (abaixo do orÃ§ado)');
                    } else {
                      lines.push('DiferenÃ§a: R$ 0,00 (exatamente no orÃ§ado)');
                    }
                    lines.push('Porcentagem: ' + percentage.toFixed(1) + '%');
                  } else {
                    lines.push('OrÃ§ado: R$ 0,00 (sem orÃ§amento definido)');
                    lines.push('DiferenÃ§a: R$ ' + spent.toFixed(2) + ' (sem referÃªncia)');
                    lines.push('Porcentagem: N/A');
                  }
                  
                  return lines;
                }
              }
            }
          }
        }
      });
    }
  }
  
  // Inicializar grÃ¡fico
  if (originalChartData && originalChartData.length > 0) {
    // Popular o dropdown com as subcategorias disponÃ­veis
    populateSubcategoriesDropdown();
    
    // Inicializar grÃ¡fico (sem exclusÃµes)
    updateChart();
    updateExclusionsCount();
    
    // Event listener para o botÃ£o do dropdown
    const btn = document.getElementById('excludeSubcategoriesBtn');
    if (btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleExcludeDropdown();
      });
    }
    
    // Event listener para o botÃ£o "Limpar"
    const clearBtn = document.getElementById('clearExclusionsBtn');
    if (clearBtn) {
      clearBtn.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('#excludeSubcategoriesList input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        updateChart();
        updateExclusionsCount();
      });
    }
    
    // Fechar dropdown quando clicar fora
    document.addEventListener('click', function(event) {
      const btn = document.getElementById('excludeSubcategoriesBtn');
      const dropdown = document.getElementById('excludeSubcategoriesDropdown');
      
      if (btn && dropdown && !btn.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.style.display = 'none';
      }
    });
  }
{% endif %}
</script>
{% endblock %}

