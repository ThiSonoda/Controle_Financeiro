{% extends "finance/base.html" %}
{% load static %}

{% block content %}
<h1>Todos os Lançamentos</h1>

<style>
  .filters-container {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    border: 1px solid #ddd;
  }
  .filters-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: flex-end;
    margin-bottom: 10px;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }
  .filter-group label {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 14px;
  }
  .filter-group select, 
  .filter-group input[type="number"] {
    width: 100%;
    box-sizing: border-box;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    height: 32px;
    line-height: 1.4;
  }
  .filter-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
</style>

<div class="filters-container">
  <h3 style="margin-top: 0; margin-bottom: 15px;">Filtros</h3>
  <form method="get" action="">
    <div class="filters-row">
      <div class="filter-group">
        <label for="id_year">Ano:</label>
        <input type="number" id="id_year" name="year" value="{{ year }}" min="2020" max="2100">
      </div>
      <div class="filter-group">
        <label for="id_month">Mês:</label>
        <select id="id_month" name="month">
          <option value="0" {% if month == 0 %}selected{% endif %}>Todos</option>
          <option value="1" {% if month == 1 %}selected{% endif %}>Janeiro</option>
          <option value="2" {% if month == 2 %}selected{% endif %}>Fevereiro</option>
          <option value="3" {% if month == 3 %}selected{% endif %}>Março</option>
          <option value="4" {% if month == 4 %}selected{% endif %}>Abril</option>
          <option value="5" {% if month == 5 %}selected{% endif %}>Maio</option>
          <option value="6" {% if month == 6 %}selected{% endif %}>Junho</option>
          <option value="7" {% if month == 7 %}selected{% endif %}>Julho</option>
          <option value="8" {% if month == 8 %}selected{% endif %}>Agosto</option>
          <option value="9" {% if month == 9 %}selected{% endif %}>Setembro</option>
          <option value="10" {% if month == 10 %}selected{% endif %}>Outubro</option>
          <option value="11" {% if month == 11 %}selected{% endif %}>Novembro</option>
          <option value="12" {% if month == 12 %}selected{% endif %}>Dezembro</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="id_type">Tipo:</label>
        <select id="id_type" name="type">
          <option value="">Todos</option>
          <option value="IN" {% if filter_type == "IN" %}selected{% endif %}>Receita</option>
          <option value="EX" {% if filter_type == "EX" %}selected{% endif %}>Despesa</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="id_credit_card">Cartão:</label>
        <select id="id_credit_card" name="credit_card">
          <option value="">Todos</option>
          <option value="debit" {% if filter_credit_card == "debit" %}selected{% endif %}>Débito</option>
          {% for card in credit_cards %}
            <option value="{{ card.id }}" {% if filter_credit_card|stringformat:"s" == card.id|stringformat:"s" %}selected{% endif %}>{{ card.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="id_status">Status:</label>
        <select id="id_status" name="status">
          <option value="">Todos</option>
          <option value="paid" {% if filter_status == "paid" %}selected{% endif %}>Paga</option>
          <option value="pending" {% if filter_status == "pending" %}selected{% endif %}>Pendente</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="id_subcategory">Subcategoria:</label>
        <select id="id_subcategory" name="subcategory">
          <option value="">Todas</option>
          {% for subcat in subcategories %}
            <option value="{{ subcat.id }}" {% if filter_subcategory|stringformat:"s" == subcat.id|stringformat:"s" %}selected{% endif %}>{{ subcat.name }} - {{ subcat.category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="id_installment">Parcelado:</label>
        <select id="id_installment" name="installment">
          <option value="">Todos</option>
          <option value="yes" {% if filter_installment == "yes" %}selected{% endif %}>Sim</option>
          <option value="no" {% if filter_installment == "no" %}selected{% endif %}>Não</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="id_owner_tag">Tag:</label>
        <select id="id_owner_tag" name="owner_tag">
          <option value="">Todas</option>
          <option value="Thi" {% if filter_owner_tag == "Thi" %}selected{% endif %}>Thiago</option>
          <option value="Tha" {% if filter_owner_tag == "Tha" %}selected{% endif %}>Thaís</option>
        </select>
      </div>
    </div>
    <div class="filter-buttons">
      <button type="submit">Aplicar Filtros</button>
      <a href="{% url 'finance:all_transactions' %}?year={{ year }}&month={{ month }}" style="padding: 6px 12px; background-color: #666; color: white; border-radius: 4px; text-decoration: none; display: inline-block;">Limpar Filtros</a>
    </div>
  </form>
</div>

<h2 style="margin-top: 0;">{% if month == 0 %}Ano {{ year }} (Todos os meses){% else %}Mês {{ month }}/{{ year }}{% endif %}</h2>

{% if transactions %}
  <form id="bulk_delete_form" method="post" action="{% url 'finance:bulk_delete_transactions' %}" onsubmit="return confirmBulkDelete();">
    {% csrf_token %}
    <div style="margin-bottom: 15px;">
      <button type="submit" style="padding: 8px 16px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Deletar Selecionados
      </button>
      <span id="selected_count" style="margin-left: 15px; color: #666; font-weight: bold;"></span>
    </div>

  <table border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th style="width: 40px;">
          <input type="checkbox" id="select_all_checkbox" onchange="toggleSelectAll()">
        </th>
        <th>Data Lançamento</th>
        <th>Data Pagamento</th>
        <th>Tipo</th>
        <th style="min-width: 100px;">Valor</th>
        <th>Categoria</th>
        <th>Cartão</th>
        <th>Tag</th>
        <th>Descrição</th>
        <th>Comentário</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for t in transactions %}
        <tr>
          <td style="text-align: center;">
            <input type="checkbox" name="transaction_ids" value="{{ t.id }}" class="transaction_checkbox" onchange="updateSelectedCount()">
          </td>
          <td>{{ t.date|date:"d/m/Y" }}</td>
          <td>
            {% if t.payment_date %}
              {{ t.payment_date|date:"d/m/Y" }}
              {% if t.date != t.payment_date %}
                <small style="color: #666; display: block;">(vencimento)</small>
              {% endif %}
            {% else %}
              {{ t.date|date:"d/m/Y" }}
            {% endif %}
          </td>
          <td>
            {% if t.type == "IN" %}
              <span style="color: #2e7d32; font-weight: bold;">Receita</span>
            {% else %}
              <span style="color: #c62828; font-weight: bold;">Despesa</span>
            {% endif %}
          </td>
          <td style="min-width: 100px;">
            {% if t.type == "EX" %}-{% endif %}
            R$ {{ t.amount|floatformat:2 }}
          </td>
          <td>
            {% if t.subcategory %}
              {{ t.subcategory.name }} - {{ t.subcategory.category.name }}
            {% else %}
              {{ t.category.name|default:"-" }}
            {% endif %}
          </td>
          <td>{{ t.credit_card.name|default:"-" }}</td>
          <td>
            {% if t.owner_tag %}
              {{ t.get_owner_tag_display }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ t.description|default:"-" }}</td>
          <td>
            {% if t.comment %}
              <span title="{{ t.comment }}">{{ t.comment|truncatewords:10 }}</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if t.credit_card %}
              {% if t.is_paid %}
                <span style="color: #4caf50;">✓ Paga</span>
              {% else %}
                <span style="color: #ff9800;">Pendente</span>
              {% endif %}
            {% else %}
              <span style="color: #4caf50;">✓ Paga</span>
            {% endif %}
          </td>
          <td>
            <a href="{% url 'finance:edit_transaction' t.id %}?next={{ return_url }}" style="margin-right: 8px;">Editar</a>
            <form method="post" action="{% url 'finance:delete_transaction' t.id %}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja deletar este lançamento?');">
              {% csrf_token %}
              <button type="submit" class="logout-link" style="color: #c62828; padding: 0; margin: 0; background: none; border: none; cursor: pointer; text-decoration: underline;">Deletar</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  </form>
  
  <!-- Controles de Paginação -->
  <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
    <p style="color: #666; margin: 0;">
      Mostrando {{ transactions.start_index }} a {{ transactions.end_index }} de {{ transactions.paginator.count }} lançamento(s)
    </p>
    
    <div style="display: flex; gap: 10px; align-items: center;">
      {% if transactions.has_previous %}
        <a href="{% url 'finance:all_transactions' %}{% if pagination_base_query %}?{{ pagination_base_query }}&{% else %}?{% endif %}page=1" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; background: #fff;">« Primeira</a>
        <a href="{% url 'finance:all_transactions' %}{% if pagination_base_query %}?{{ pagination_base_query }}&{% else %}?{% endif %}page={{ transactions.previous_page_number }}" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; background: #fff;">‹ Anterior</a>
      {% else %}
        <span style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; color: #999; background: #f5f5f5;">« Primeira</span>
        <span style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; color: #999; background: #f5f5f5;">‹ Anterior</span>
      {% endif %}
      
      <span style="padding: 6px 12px; color: #333; font-weight: bold;">
        Página {{ transactions.number }} de {{ transactions.paginator.num_pages }}
      </span>
      
      {% if transactions.has_next %}
        <a href="{% url 'finance:all_transactions' %}{% if pagination_base_query %}?{{ pagination_base_query }}&{% else %}?{% endif %}page={{ transactions.next_page_number }}" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; background: #fff;">Próxima ›</a>
        <a href="{% url 'finance:all_transactions' %}{% if pagination_base_query %}?{{ pagination_base_query }}&{% else %}?{% endif %}page={{ transactions.paginator.num_pages }}" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; background: #fff;">Última »</a>
      {% else %}
        <span style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; color: #999; background: #f5f5f5;">Próxima ›</span>
        <span style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; color: #999; background: #f5f5f5;">Última »</span>
      {% endif %}
    </div>
  </div>
{% else %}
  <p>Nenhum lançamento encontrado.</p>
{% endif %}

<script>
  function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select_all_checkbox');
    const checkboxes = document.querySelectorAll('.transaction_checkbox');
    const isChecked = selectAllCheckbox.checked;
    
    checkboxes.forEach(cb => {
      cb.checked = isChecked;
    });
    
    updateSelectedCount();
  }

  function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.transaction_checkbox:checked');
    const count = checkboxes.length;
    const countSpan = document.getElementById('selected_count');
    
    if (count > 0) {
      countSpan.textContent = `${count} lançamento(s) selecionado(s)`;
    } else {
      countSpan.textContent = '';
    }
    
    // Atualizar o checkbox "Selecionar todos"
    const selectAllCheckbox = document.getElementById('select_all_checkbox');
    const allCheckboxes = document.querySelectorAll('.transaction_checkbox');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
    selectAllCheckbox.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
  }

  function confirmBulkDelete() {
    const checkboxes = document.querySelectorAll('.transaction_checkbox:checked');
    if (checkboxes.length === 0) {
      alert('Por favor, selecione pelo menos um lançamento para deletar.');
      return false;
    }
    
    return confirm(`Tem certeza que deseja deletar ${checkboxes.length} lançamento(s)? Esta ação não pode ser desfeita.`);
  }

  // Preservar os filtros após a deleção
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bulk_delete_form');
    if (form) {
      // Adicionar campos hidden com os filtros atuais da URL
      const urlParams = new URLSearchParams(window.location.search);
      urlParams.forEach((value, key) => {
        if (key !== 'transaction_ids' && !form.querySelector(`input[name="${key}"]`)) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          form.appendChild(input);
        }
      });
    }
    
    // Inicializar contador
    updateSelectedCount();
  });
</script>

{% endblock %}

