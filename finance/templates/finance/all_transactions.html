{% extends "finance/base.html" %}
{% load static %}

{% block content %}
<h1>Todos os Lançamentos</h1>

<style>
  .filters-container {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    border: 1px solid #ddd;
  }
  .filters-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: flex-end;
    margin-bottom: 10px;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }
  .filter-group label {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 14px;
  }
  .filter-group select, 
  .filter-group input[type="number"] {
    width: 100%;
    box-sizing: border-box;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    height: 32px;
    line-height: 1.4;
  }
  .filter-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  
  /* Tooltip para comentário */
  .comment-icon {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .comment-icon:hover {
    border-color: #666 !important;
    color: #666 !important;
  }
  
  .comment-tooltip {
    visibility: hidden;
    opacity: 0;
    background-color: #333;
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 10px 12px;
    position: absolute;
    z-index: 1000;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    white-space: pre-wrap;
    word-wrap: break-word;
    max-width: 300px;
    font-size: 13px;
    line-height: 1.4;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: opacity 0.3s, visibility 0.3s;
    pointer-events: none;
  }
  
  .comment-tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
  }
  
  .comment-icon:hover .comment-tooltip {
    visibility: visible;
    opacity: 1;
  }
</style>

<div class="filters-container">
  <h3 style="margin-top: 0; margin-bottom: 15px;">Filtros</h3>
  <form method="get" action="">
    <div class="filters-row">
      <div class="filter-group">
        <label for="id_year">Ano:</label>
        <input type="number" id="id_year" name="year" value="{{ year }}" min="2020" max="2100">
      </div>
      <div class="filter-group">
        <label for="id_month">Mês:</label>
        <select id="id_month" name="month">
          <option value="0" {% if month == 0 %}selected{% endif %}>Todos</option>
          <option value="1" {% if month == 1 %}selected{% endif %}>Janeiro</option>
          <option value="2" {% if month == 2 %}selected{% endif %}>Fevereiro</option>
          <option value="3" {% if month == 3 %}selected{% endif %}>Março</option>
          <option value="4" {% if month == 4 %}selected{% endif %}>Abril</option>
          <option value="5" {% if month == 5 %}selected{% endif %}>Maio</option>
          <option value="6" {% if month == 6 %}selected{% endif %}>Junho</option>
          <option value="7" {% if month == 7 %}selected{% endif %}>Julho</option>
          <option value="8" {% if month == 8 %}selected{% endif %}>Agosto</option>
          <option value="9" {% if month == 9 %}selected{% endif %}>Setembro</option>
          <option value="10" {% if month == 10 %}selected{% endif %}>Outubro</option>
          <option value="11" {% if month == 11 %}selected{% endif %}>Novembro</option>
          <option value="12" {% if month == 12 %}selected{% endif %}>Dezembro</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="id_type">Tipo:</label>
        <select id="id_type" name="type">
          <option value="">Todos</option>
          <option value="IN" {% if filter_type == "IN" %}selected{% endif %}>Receita</option>
          <option value="EX" {% if filter_type == "EX" %}selected{% endif %}>Despesa</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="id_credit_card">Cartão:</label>
        <select id="id_credit_card" name="credit_card">
          <option value="">Todos</option>
          <option value="debit" {% if filter_credit_card == "debit" %}selected{% endif %}>Débito</option>
          {% for card in credit_cards %}
            <option value="{{ card.id }}" {% if filter_credit_card|stringformat:"s" == card.id|stringformat:"s" %}selected{% endif %}>{{ card.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="id_status">Status:</label>
        <select id="id_status" name="status">
          <option value="">Todos</option>
          <option value="paid" {% if filter_status == "paid" %}selected{% endif %}>Paga</option>
          <option value="pending" {% if filter_status == "pending" %}selected{% endif %}>Pendente</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="id_installment">Parcelado:</label>
        <select id="id_installment" name="installment">
          <option value="">Todos</option>
          <option value="yes" {% if filter_installment == "yes" %}selected{% endif %}>Sim</option>
          <option value="no" {% if filter_installment == "no" %}selected{% endif %}>Não</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="id_owner_tag">Tag:</label>
        <select id="id_owner_tag" name="owner_tag">
          <option value="">Todas</option>
          <option value="Thi" {% if filter_owner_tag == "Thi" %}selected{% endif %}>Thiago</option>
          <option value="Tha" {% if filter_owner_tag == "Tha" %}selected{% endif %}>Thaís</option>
        </select>
      </div>
    </div>
    <div class="filters-row">
      <div class="filter-group" style="flex: 1; position: relative;">
        <label for="id_subcategory_search">Subcategoria:</label>
        <input type="text" 
               id="id_subcategory_search" 
               autocomplete="off"
               placeholder="Digite para buscar..."
               style="width: 100%; box-sizing: border-box; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; font-family: inherit; height: 32px; line-height: 1.4;">
        <input type="hidden" id="id_subcategory" name="subcategory" value="{{ filter_subcategory }}">
        <div id="subcategory_dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        </div>
      </div>
      <div class="filter-group" style="flex: 1;">
        <label for="id_description">Descrição:</label>
        <input type="text" id="id_description" name="description" value="{{ filter_description }}" placeholder="Buscar na descrição..." style="width: 100%; box-sizing: border-box; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; font-family: inherit; height: 32px; line-height: 1.4;">
      </div>
    </div>
    <div class="filter-buttons">
      <button type="submit">Aplicar Filtros</button>
      <a href="{% url 'finance:all_transactions' %}?year={{ year }}&month={{ month }}" style="padding: 6px 12px; background-color: #666; color: white; border-radius: 4px; text-decoration: none; display: inline-block;">Limpar Filtros</a>
    </div>
  </form>
</div>

<h2 style="margin-top: 0;">{% if month == 0 %}Ano {{ year }} (Todos os meses){% else %}Mês {{ month }}/{{ year }}{% endif %}</h2>

{% if transactions %}
  <form id="bulk_delete_form" method="post" action="{% url 'finance:bulk_delete_transactions' %}" onsubmit="return confirmBulkDelete();">
    {% csrf_token %}
    <div style="margin-bottom: 15px;">
      <button type="submit" style="padding: 8px 16px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Deletar Selecionados
      </button>
      <span id="selected_count" style="margin-left: 15px; color: #666; font-weight: bold;"></span>
    </div>

  <table border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th style="width: 40px;">
          <input type="checkbox" id="select_all_checkbox" onchange="toggleSelectAll()">
        </th>
        <th>Data Lançamento</th>
        <th>Data Pagamento</th>
        <th>Tipo</th>
        <th style="min-width: 100px;">Valor</th>
        <th>Categoria</th>
        <th>Cartão</th>
        <th>Tag</th>
        <th>Descrição</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for t in transactions %}
        <tr>
          <td style="text-align: center;">
            <input type="checkbox" name="transaction_ids" value="{{ t.id }}" class="transaction_checkbox" onchange="updateSelectedCount()">
          </td>
          <td>{{ t.date|date:"d/m/Y" }}</td>
          <td>
            {% if t.payment_date %}
              {{ t.payment_date|date:"d/m/Y" }}
              {% if t.date != t.payment_date %}
                <small style="color: #666; display: block;">(vencimento)</small>
              {% endif %}
            {% else %}
              {{ t.date|date:"d/m/Y" }}
            {% endif %}
          </td>
          <td>
            {% if t.type == "IN" %}
              <span style="color: #2e7d32; font-weight: bold;">Receita</span>
            {% else %}
              <span style="color: #c62828; font-weight: bold;">Despesa</span>
            {% endif %}
          </td>
          <td style="min-width: 100px;">
            {% if t.type == "EX" %}-{% endif %}
            R$ {{ t.amount|floatformat:2 }}
          </td>
          <td>
            {% if t.subcategory %}
              {{ t.subcategory.name }} - {{ t.subcategory.category.name }}
            {% else %}
              {{ t.category.name|default:"-" }}
            {% endif %}
          </td>
          <td>{{ t.credit_card.name|default:"-" }}</td>
          <td>
            {% if t.owner_tag %}
              {{ t.get_owner_tag_display }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {{ t.description|default:"-" }}
            {% if t.comment and t.comment|length > 0 %}
              <span class="comment-icon" style="cursor: pointer; margin-left: 5px; vertical-align: middle; display: inline-flex; align-items: center; justify-content: center; width: 12px; height: 12px; border-radius: 50%; border: 1px solid #999; color: #999; font-size: 8px; font-weight: bold; font-style: italic; font-family: serif; line-height: 1;">
                i
                <span class="comment-tooltip">{{ t.comment }}</span>
              </span>
            {% endif %}
          </td>
          <td>
            {% if t.credit_card %}
              {% if t.is_paid %}
                <span style="color: #4caf50;">✓ Paga</span>
              {% else %}
                <span style="color: #ff9800;">Pendente</span>
              {% endif %}
            {% else %}
              <span style="color: #4caf50;">✓ Paga</span>
            {% endif %}
          </td>
          <td>
            <a href="{% url 'finance:edit_transaction' t.id %}?next={{ return_url }}" style="margin-right: 8px;">Editar</a>
            <form method="post" action="{% url 'finance:delete_transaction' t.id %}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja deletar este lançamento?');">
              {% csrf_token %}
              <button type="submit" class="logout-link" style="color: #c62828; padding: 0; margin: 0; background: none; border: none; cursor: pointer; text-decoration: underline;">Deletar</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="4" style="font-weight: bold; text-align: right;">Total</td>
        <td style="font-weight: bold; min-width: 100px;">
          R$ {{ total_signed_amount|floatformat:2 }}
        </td>
        <td colspan="7"></td>
      </tr>
    </tfoot>
  </table>
  </form>
  
  <!-- Controles de Paginação -->
  <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
    <p style="color: #666; margin: 0;">
      Mostrando {{ transactions.start_index }} a {{ transactions.end_index }} de {{ transactions.paginator.count }} lançamento(s)
    </p>
    
    <div style="display: flex; gap: 10px; align-items: center;">
      {% if transactions.has_previous %}
        <a href="{% url 'finance:all_transactions' %}{% if pagination_base_query %}?{{ pagination_base_query }}&{% else %}?{% endif %}page=1" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; background: #fff;">« Primeira</a>
        <a href="{% url 'finance:all_transactions' %}{% if pagination_base_query %}?{{ pagination_base_query }}&{% else %}?{% endif %}page={{ transactions.previous_page_number }}" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; background: #fff;">‹ Anterior</a>
      {% else %}
        <span style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; color: #999; background: #f5f5f5;">« Primeira</span>
        <span style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; color: #999; background: #f5f5f5;">‹ Anterior</span>
      {% endif %}
      
      <span style="padding: 6px 12px; color: #333; font-weight: bold;">
        Página {{ transactions.number }} de {{ transactions.paginator.num_pages }}
      </span>
      
      {% if transactions.has_next %}
        <a href="{% url 'finance:all_transactions' %}{% if pagination_base_query %}?{{ pagination_base_query }}&{% else %}?{% endif %}page={{ transactions.next_page_number }}" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; background: #fff;">Próxima ›</a>
        <a href="{% url 'finance:all_transactions' %}{% if pagination_base_query %}?{{ pagination_base_query }}&{% else %}?{% endif %}page={{ transactions.paginator.num_pages }}" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; background: #fff;">Última »</a>
      {% else %}
        <span style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; color: #999; background: #f5f5f5;">Próxima ›</span>
        <span style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; color: #999; background: #f5f5f5;">Última »</span>
      {% endif %}
    </div>
  </div>
{% else %}
  <p>Nenhum lançamento encontrado.</p>
{% endif %}

<script>
  function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select_all_checkbox');
    const checkboxes = document.querySelectorAll('.transaction_checkbox');
    const isChecked = selectAllCheckbox.checked;
    
    checkboxes.forEach(cb => {
      cb.checked = isChecked;
    });
    
    updateSelectedCount();
  }

  function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.transaction_checkbox:checked');
    const count = checkboxes.length;
    const countSpan = document.getElementById('selected_count');
    
    if (count > 0) {
      countSpan.textContent = `${count} lançamento(s) selecionado(s)`;
    } else {
      countSpan.textContent = '';
    }
    
    // Atualizar o checkbox "Selecionar todos"
    const selectAllCheckbox = document.getElementById('select_all_checkbox');
    const allCheckboxes = document.querySelectorAll('.transaction_checkbox');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
    selectAllCheckbox.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
  }

  function confirmBulkDelete() {
    const checkboxes = document.querySelectorAll('.transaction_checkbox:checked');
    if (checkboxes.length === 0) {
      alert('Por favor, selecione pelo menos um lançamento para deletar.');
      return false;
    }
    
    return confirm(`Tem certeza que deseja deletar ${checkboxes.length} lançamento(s)? Esta ação não pode ser desfeita.`);
  }

  // Preservar os filtros após a deleção
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bulk_delete_form');
    if (form) {
      // Adicionar campos hidden com os filtros atuais da URL
      const urlParams = new URLSearchParams(window.location.search);
      urlParams.forEach((value, key) => {
        if (key !== 'transaction_ids' && !form.querySelector(`input[name="${key}"]`)) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          form.appendChild(input);
        }
      });
    }
    
    // Inicializar contador
    updateSelectedCount();
  });
</script>

<!-- JavaScript para campo de busca de subcategoria -->
<script>
  (function() {
    // Preparar dados de subcategorias do template
    const subcategories = [
      {% for subcat in subcategories %}
      {
        id: {{ subcat.id }},
        name: "{{ subcat.name|escapejs }}",
        category: "{{ subcat.category.name|escapejs }}",
        displayText: "{{ subcat.category.name|escapejs }} - {{ subcat.name|escapejs }}",
        isIncome: {{ subcat.category.is_income|lower }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    const searchInput = document.getElementById('id_subcategory_search');
    const hiddenInput = document.getElementById('id_subcategory');
    const dropdown = document.getElementById('subcategory_dropdown');
    let selectedIndex = -1;
    let filteredSubcategories = [];

    // Buscar subcategoria selecionada inicialmente
    const initialSubcategoryId = hiddenInput.value;
    if (initialSubcategoryId) {
      const selected = subcategories.find(s => s.id == initialSubcategoryId);
      if (selected) {
        searchInput.value = selected.displayText;
      }
    }

    function filterSubcategories(query) {
      if (!query || query.trim() === '') {
        return subcategories;
      }
      const lowerQuery = query.toLowerCase();
      return subcategories.filter(subcat => 
        subcat.name.toLowerCase().includes(lowerQuery) ||
        subcat.category.toLowerCase().includes(lowerQuery) ||
        subcat.displayText.toLowerCase().includes(lowerQuery)
      );
    }

    function renderDropdown(subcategories) {
      filteredSubcategories = subcategories;
      selectedIndex = -1;
      
      if (subcategories.length === 0) {
        dropdown.innerHTML = '<div style="padding: 10px; color: #666;">Nenhuma subcategoria encontrada</div>';
        dropdown.style.display = 'block';
        return;
      }

      dropdown.innerHTML = subcategories.map((subcat, index) => 
        `<div class="subcategory-option" data-index="${index}" data-id="${subcat.id}" style="padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #eee;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='white'">
          <strong>${subcat.name}</strong> - ${subcat.category}${subcat.isIncome ? ' <span style="color: #2e7d32;">(receita)</span>' : ''}
        </div>`
      ).join('');

      dropdown.querySelectorAll('.subcategory-option').forEach(option => {
        option.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          selectSubcategory(filteredSubcategories[index]);
        });
      });

      dropdown.style.display = 'block';
    }

    function selectSubcategory(subcat) {
      hiddenInput.value = subcat.id;
      searchInput.value = subcat.displayText;
      dropdown.style.display = 'none';
      selectedIndex = -1;
    }

    function highlightOption(index) {
      const options = dropdown.querySelectorAll('.subcategory-option');
      options.forEach((opt, i) => {
        if (i === index) {
          opt.style.backgroundColor = '#e3f2fd';
          opt.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
          opt.style.backgroundColor = 'white';
        }
      });
    }

    searchInput.addEventListener('input', function() {
      const query = this.value;
      const filtered = filterSubcategories(query);
      renderDropdown(filtered);
      
      if (hiddenInput.value) {
        const selected = subcategories.find(s => s.id == hiddenInput.value);
        if (!selected || selected.displayText !== query) {
          hiddenInput.value = '';
        }
      }
    });

    searchInput.addEventListener('focus', function() {
      if (this.value) {
        const filtered = filterSubcategories(this.value);
        renderDropdown(filtered);
      } else {
        renderDropdown(subcategories);
      }
    });

    searchInput.addEventListener('keydown', function(e) {
      if (!dropdown.style.display || dropdown.style.display === 'none') {
        return;
      }

      const options = dropdown.querySelectorAll('.subcategory-option');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, options.length - 1);
        highlightOption(selectedIndex);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        if (selectedIndex >= 0) {
          highlightOption(selectedIndex);
        } else {
          options.forEach(opt => opt.style.backgroundColor = 'white');
        }
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedIndex >= 0 && filteredSubcategories[selectedIndex]) {
          selectSubcategory(filteredSubcategories[selectedIndex]);
        } else if (filteredSubcategories.length === 1) {
          selectSubcategory(filteredSubcategories[0]);
        }
      } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
        selectedIndex = -1;
      }
    });

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
  })();
</script>

{% endblock %}

