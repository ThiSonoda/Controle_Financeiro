{% extends "finance/base.html" %}
{% load static %}

{% block content %}
<h1>Lançamentos (Receitas / Despesas)</h1>

<!-- {% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %} -->

<h2>Novo lançamento</h2>

<!-- Card selector nav (Débito + Credit Cards) -->
<div style="margin: 12px 0 20px 0;">
  <div id="card_selector" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <button type="button" class="card-btn" data-card-id="" data-card-name="">Débito</button>
    {% for card in credit_cards %}
      <button type="button" class="card-btn" data-card-id="{{ card.id }}" data-card-name="{{ card.name }}">{{ card.name }}</button>
    {% endfor %}
  </div>
</div>

<style>
  .transactions-layout { display: flex; gap: 24px; align-items: flex-start; }
  .transactions-layout .left-column { flex: 1 1 0; min-width: 320px; }
  .transactions-layout .right-column { width: 360px; max-width: 42%; }

  /* Form controls full width and spacing */
  .transactions-layout form div { margin-bottom: 12px; }
  .transactions-layout label { display: block; margin-bottom: 6px; font-weight: 600; }
  .transactions-layout input[type="text"],
  .transactions-layout input[type="date"],
  .transactions-layout input[type="number"],
  .transactions-layout input[type="month"],
  .transactions-layout select,
  .transactions-layout textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
  }
   /* Altura específica para o campo de subcategoria */
   #id_subcategory {
    height: 35px;
  }
    /* Altura específica para o campo de Tipo */
    #id_type {
    height: 40px;
  }

  .transactions-layout button { padding: 8px 14px; border-radius: 4px; }

  /* Card selector buttons */
  .card-btn {
    background: #fff;
    border: 1px solid #ddd;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    color: #222; /* ensure readable text color when not selected */
  }
  .card-btn:hover { background: #f5f7fa; color: #111; }
  .card-btn.active { background: #1976d2; color: #fff; border-color: #1976d2; font-weight: 700; }

  /* Right column visual tweaks */
  .transactions-layout .right-column { background: #fafafa; padding: 12px; border-radius: 6px; border: 1px solid #eee; }
  .transactions-layout .right-column table { width: 100%; border-collapse: collapse; }
  .transactions-layout .right-column th,
  .transactions-layout .right-column td { border: 1px solid #e6e6e6; padding: 8px; }

  @media (max-width: 900px) {
    .transactions-layout { flex-direction: column; }
    .transactions-layout .right-column { width: 100%; max-width: none; }
  }
</style>

<div class="transactions-layout">
  <div class="left-column">
    <form method="post" action="">
      {% csrf_token %}
      <div style="display: flex; gap: 16px;">
        <div style="flex: 1;">
          <label for="id_date">Data:</label>
          <input type="date" id="id_date" name="date" required value="{{ default_date }}">
        </div>

        <div style="flex: 1;">
          <label for="id_type">Tipo:</label>
          <select id="id_type" name="type" required>
            <option value="EX">Despesa</option>
            <option value="IN">Receita</option>
          </select>
        </div>
      </div>

      <div style="display: flex; gap: 16px;">
        <div style="flex: 1;">
          <label for="id_amount">Valor:</label>
          <input type="number" id="id_amount" name="amount" step="0.01" min="0" required>
        </div>

        <div style="flex: 1;">
          <label for="id_subcategory">Subcategoria:</label>
          <select id="id_subcategory" name="subcategory" required>
            <option value="">-- selecione --</option>
            {% for subcat in subcategories %}
              <option value="{{ subcat.id }}">{{ subcat.name }} - {{ subcat.category.name }}{% if subcat.category.is_income %} (receita){% endif %}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- <div>
        <label for="id_account">Conta:</label>
        <select id="id_account" name="account" required>
          <option value="">-- selecione --</option>
          {% for a in accounts %}
            <option value="{{ a.id }}">{{ a.name }}</option>
          {% endfor %}
        </select>
      </div> -->

      <!-- credit_card select removed: selection is done via the card selector nav above -->

      <div>
        <label for="id_description">Descrição:</label>
        <input type="text" id="id_description" name="description">
      </div>

      <div>
        <label for="id_comment">Comentário (opcional):</label>
        <textarea id="id_comment" name="comment" rows="3" placeholder="Adicione um comentário sobre este lançamento..."></textarea>
      </div>

      <div id="owner_tag_field" style="display: none;">
        <label for="id_owner_tag">Tag (obrigatório para cartão Bradesco):</label>
        <select id="id_owner_tag" name="owner_tag" required>
          <option value="">-- selecione --</option>
          <option value="Thi">Thiago (Thi)</option>
          <option value="Tha">Thaís (Tha)</option>
        </select>
      </div>

      <fieldset id="installment_fieldset" style="margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; display: none;">
        <legend>Compra parcelada no cartão</legend>

        <div>
          <label>
            <input type="checkbox" name="is_installment" id="id_is_installment" onchange="toggleInstallmentFields()">
            Lançar como compra parcelada?
          </label>
        </div>

        <div id="installment_fields" style="margin-top: 8px; display: none;">
          <div style="margin-bottom: 10px;">
            <label for="id_installments">Número de parcelas:</label>
            <input type="number" id="id_installments" name="installments" min="2" value="2">
          </div>
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">O valor informado é:</label>
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
              <input type="radio" name="amount_type" value="total" checked>
              <span>Valor Total da Compra</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="radio" name="amount_type" value="installment">
              <span>Valor de Cada Parcela</span>
            </label>
          </div>
          <small>
            O sistema irá criar uma transação por parcela, em meses consecutivos.
          </small>
        </div>
      </fieldset>

      <div style="margin-top: 12px;">
        <button type="submit">Salvar</button>
      </div>

    </form>

  </div>

  <aside class="right-column">
    <h2 style="margin-top: 0;">Saldo das Contas</h2>

    <section style="margin-bottom: 16px;">
      {% if accounts %}
        <ul style="list-style: none; padding: 0; margin: 0 0 8px 0;">
          {% for a in accounts %}
            <li style="display:flex; justify-content:space-between; padding:6px 8px; border-radius:4px; background:#fff; margin-bottom:6px; align-items:center;">
              <span style="font-weight:600;">{{ a.name }}</span>
              <span style="font-family: monospace; font-size: 16px;">R$ {{ a.balance|floatformat:2 }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="color:#666; margin:0 0 8px 0;">Nenhuma conta cadastrada.</p>
      {% endif %}
    </section>

    <h2 style="margin-top: 0;">Faturas dos Cartões de Crédito</h2>
    <div style="margin-bottom: 20px;">
      <label for="invoice_month" style="display: block; margin-bottom: 5px;">Mês/Ano:</label>
      <input type="month" id="invoice_month" name="invoice_month" 
             value="{{ selected_year }}-{% if selected_month < 10 %}0{% endif %}{{ selected_month }}"
             onchange="updateInvoiceMonth()" style="width: 200px;">
      <button type="button" onclick="updateInvoiceMonth()" style="margin-left: 10px;">Atualizar</button>
    </div>

    {% if credit_card_invoices %}
      <table border="1" cellspacing="0" cellpadding="8" style="width: 100%; margin-bottom: 20px;">
        <thead>
          <tr>
            <th style="text-align: center;">Cartão</th>
            <th style="text-align: center; min-width: 100px;">Total</th>
            <th style="text-align: center;">Status</th>
            <th style="text-align: center;">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in credit_card_invoices %}
            {% if invoice.count > 0 %}
              <tr>
                <td>{{ invoice.card.name }}</td>
                <td style="text-align: right; font-weight: bold; min-width: 100px;">
                  R$ {{ invoice.total|floatformat:2 }}
                </td>
                <td style="text-align: center;">
                  {% if invoice.is_paid %}
                    <span style="color: #4caf50; font-weight: bold;">✓ Paga</span>
                  {% else %}
                    <span style="color: #ff9800; font-weight: bold;">Pendente</span>
                  {% endif %}
                </td>
                <td style="text-align: center;">
                  {% if invoice.is_paid %}
                    <a href="{% url 'finance:reopen_invoice' invoice.card.id selected_year selected_month %}" 
                       style="color: #ff9800; margin-right: 10px;">Reabrir Fatura</a>
                  {% else %}
                    <a href="{% url 'finance:pay_invoice' invoice.card.id selected_year selected_month %}" 
                       style="color: #4caf50; font-weight: bold;">Pagar Fatura</a>
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="color: #666;">Nenhum cartão cadastrado ou nenhuma fatura no período selecionado.</p>
    {% endif %}

    <script>
      function updateInvoiceMonth() {
        const monthInput = document.getElementById('invoice_month');
        const value = monthInput.value;
        if (value) {
          const [year, month] = value.split('-');
          window.location.href = '{% url "finance:transactions" %}?year=' + year + '&month=' + month;
        }
      }
    </script>
  </aside>

</div>

<h2>Últimos lançamentos</h2>

<div style="margin-bottom: 15px;">
  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
    <input type="checkbox" 
           id="show_next_month" 
           {% if show_next_month %}checked{% endif %}
           onchange="toggleNextMonth()"
           style="width: auto; margin: 0;">
    <span>Mostrar mês seguinte</span>
  </label>
  <script>
    function toggleNextMonth() {
      const checkbox = document.getElementById('show_next_month');
      const url = new URL(window.location.href);
      if (checkbox.checked) {
        url.searchParams.set('next_month', '1');
      } else {
        url.searchParams.delete('next_month');
      }
      window.location.href = url.toString();
    }
  </script>
</div>

{% if transactions %}
  <table border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th>Data Lançamento</th>
        <th>Data Pagamento</th>
        <th>Tipo</th>
        <th style="min-width: 100px;">Valor</th>
        <th>Categoria</th>
        <th>Cartão</th>
        <th>Descrição</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for t in transactions %}
        <tr>
          <td>{{ t.date|date:"d/m/Y" }}</td>
          <td>
            {% if t.payment_date %}
              {{ t.payment_date|date:"d/m/Y" }}
              {% if t.date != t.payment_date %}
                <small style="color: #666; display: block;">(vencimento)</small>
              {% endif %}
            {% else %}
              {{ t.date|date:"d/m/Y" }}
            {% endif %}
          </td>
          <td>
            {% if t.type == "IN" %}
              Receita
            {% else %}
              Despesa
            {% endif %}
          </td>
          <td style="min-width: 100px;">
            {% if t.type == "EX" %}-{% endif %}
            R$ {{ t.amount }}
          </td>
          <td style="text-align: center;">
            {% if t.subcategory %}
              {{ t.subcategory.category.name }} - {{ t.subcategory.name }}
            {% else %}
              {{ t.category.name|default:"-" }}
            {% endif %}
          </td>

          <td>{{ t.credit_card.name|default:"-" }}</td>
          <td>{{ t.description }}</td>
          <td>
            <a href="{% url 'finance:edit_transaction' t.id %}" style="margin-right: 8px;">Editar</a>
            <form method="post" action="{% url 'finance:delete_transaction' t.id %}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja deletar este lançamento?');">
              {% csrf_token %}
              <button type="submit" class="logout-link" style="color: #c62828; padding: 0; margin: 0;">Deletar</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3" style="font-weight: bold; text-align: right;">Total</td>
        <td style="font-weight: bold; min-width: 100px;">
          R$ {{ total_signed_amount|floatformat:2 }}
        </td>
        <td colspan="3"></td>
        <td></td>
      </tr>
    </tfoot>
  </table>
{% else %}
  <p>Nenhum lançamento encontrado.</p>
{% endif %}

<script>
  function toggleInstallmentFields() {
    const chk = document.getElementById('id_is_installment');
    const box = document.getElementById('installment_fields');
    box.style.display = chk.checked ? 'block' : 'none';
  }
</script>

<script>
  // Card selector behaviour: persist selection in localStorage and inject hidden input into the form
  (function(){
    const selector = document.getElementById('card_selector');
    if (!selector) return;
    const buttons = Array.from(selector.querySelectorAll('.card-btn'));
    const storageKey = 'selected_card_id';

    function setActive(button, doReload = false){
      buttons.forEach(b => b.classList.toggle('active', b === button));
      const id = button.getAttribute('data-card-id') || '';
      const cardName = button.getAttribute('data-card-name') || '';
      try { localStorage.setItem(storageKey, id); } catch(e) {}
      
      // Mostrar/ocultar opção de compra parcelada baseado na seleção
      const installmentFieldset = document.getElementById('installment_fieldset');
      if (installmentFieldset) {
        // Se um cartão de crédito foi selecionado (id não vazio), mostrar o fieldset
        // Se "Débito" foi selecionado (id vazio), ocultar o fieldset
        if (id && id.trim() !== '') {
          installmentFieldset.style.display = 'block';
        } else {
          installmentFieldset.style.display = 'none';
          // Também desmarcar o checkbox e ocultar os campos de parcelas se estiverem visíveis
          const checkbox = document.getElementById('id_is_installment');
          if (checkbox) {
            checkbox.checked = false;
            toggleInstallmentFields();
          }
        }
      }

      // Aplicar filtro da tabela de últimos lançamentos conforme seleção do nav
      if (doReload) {
        const url = new URL(window.location.href);
        if (id && id.trim() !== '') {
          url.searchParams.set('payment_method', id);
        } else {
          url.searchParams.set('payment_method', 'debit');
        }
        window.location.href = url.toString();
        return; // evita execução extra após intenção de recarregar
      }

      // Mostrar/ocultar campo de tag baseado no cartão selecionado
      const ownerTagField = document.getElementById('owner_tag_field');
      const ownerTagSelect = document.getElementById('id_owner_tag');
      if (ownerTagField && ownerTagSelect) {
        // Verificar se o cartão é Bradesco (comparação case-insensitive)
        const isBradesco = cardName && cardName.toLowerCase().includes('bradesco');
        if (isBradesco) {
          ownerTagField.style.display = 'block';
          ownerTagSelect.required = true;
        } else {
          ownerTagField.style.display = 'none';
          ownerTagSelect.required = false;
          ownerTagSelect.value = ''; // Limpar valor quando não é Bradesco
        }
      }
    }

    buttons.forEach(btn => btn.addEventListener('click', function(){ setActive(btn, true); }));

    // Initialize
    let saved = null;
    try { saved = localStorage.getItem(storageKey); } catch(e) { saved = null; }
    let initial = buttons.find(b => b.getAttribute('data-card-id') === saved) || buttons[0];
    setActive(initial);

    // On submit, ensure a hidden input named 'credit_card' is present with the selected id (or empty for debit)
    const form = document.querySelector('.transactions-layout .left-column form');
    if (form){
      form.addEventListener('submit', function(){
        let hidden = form.querySelector('input[name="credit_card"]');
        if (!hidden){
          hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'credit_card';
          form.appendChild(hidden);
        }
        const active = selector.querySelector('.card-btn.active');
        hidden.value = active ? (active.getAttribute('data-card-id') || '') : '';
      });
    }
  })();
</script>

{% endblock %}
