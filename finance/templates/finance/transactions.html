{% extends "finance/base.html" %}
{% load static %}

{% block content %}
<h1>Lançamentos (Receitas / Despesas)</h1>

{% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<h2>Novo lançamento</h2>

<form method="post" action="">
  {% csrf_token %}
  <div>
    <label for="id_date">Data:</label>
    <input type="date" id="id_date" name="date" required>
  </div>

  <div>
    <label for="id_type">Tipo:</label>
    <select id="id_type" name="type" required>
      <option value="IN">Receita</option>
      <option value="EX">Despesa</option>
    </select>
  </div>

  <div>
    <label for="id_amount">Valor:</label>
    <input type="number" id="id_amount" name="amount" step="0.01" min="0" required>
  </div>

  <div>
    <label for="id_category">Categoria:</label>
    <select id="id_category" name="category" required>
      <option value="">-- selecione --</option>
      {% for c in categories %}
        <option value="{{ c.id }}">{{ c.name }}{% if c.is_income %} (receita){% endif %}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label for="id_account">Conta:</label>
    <select id="id_account" name="account" required>
      <option value="">-- selecione --</option>
      {% for a in accounts %}
        <option value="{{ a.id }}">{{ a.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label for="id_credit_card">Cartão de Crédito (opcional):</label>
    <select id="id_credit_card" name="credit_card">
      <option value="">-- nenhum --</option>
      {% for card in credit_cards %}
        <option value="{{ card.id }}">{{ card.name }}</option>
      {% endfor %}
    </select>
    <small style="display: block; color: #666; margin-top: 4px;">
      Se selecionado, a data de pagamento será ajustada para a data de vencimento da fatura do cartão.
      A data de lançamento permanecerá como a data informada acima.
      <a href="{% url 'finance:credit_cards' %}" target="_blank">Gerenciar cartões</a>
    </small>
  </div>

  <div>
    <label for="id_description">Descrição:</label>
    <input type="text" id="id_description" name="description">
  </div>

  <fieldset style="margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
    <legend>Compra parcelada no cartão</legend>

    <div>
      <label>
        <input type="checkbox" name="is_installment" id="id_is_installment" onchange="toggleInstallmentFields()">
        Lançar como compra parcelada?
      </label>
    </div>

    <div id="installment_fields" style="margin-top: 8px; display: none;">
      <div>
        <label for="id_installments">Número de parcelas:</label>
        <input type="number" id="id_installments" name="installments" min="2" value="2">
      </div>
      <small>
        O valor informado acima será considerado o <strong>valor total da compra</strong>.
        O sistema irá criar uma transação por parcela, em meses consecutivos.
      </small>
    </div>
  </fieldset>

  <div style="margin-top: 12px;">
    <button type="submit">Salvar</button>
  </div>
</form>

<hr>

<h2>Últimos lançamentos</h2>

{% if transactions %}
  <table border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th>Data Lançamento</th>
        <th>Data Pagamento</th>
        <th>Tipo</th>
        <th>Valor</th>
        <th>Categoria</th>
        <th>Conta</th>
        <th>Cartão</th>
        <th>Descrição</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for t in transactions %}
        <tr>
          <td>{{ t.date|date:"d/m/Y" }}</td>
          <td>
            {% if t.payment_date %}
              {{ t.payment_date|date:"d/m/Y" }}
              {% if t.date != t.payment_date %}
                <small style="color: #666; display: block;">(vencimento)</small>
              {% endif %}
            {% else %}
              {{ t.date|date:"d/m/Y" }}
            {% endif %}
          </td>
          <td>
            {% if t.type == "IN" %}
              Receita
            {% else %}
              Despesa
            {% endif %}
          </td>
          <td>
            {% if t.type == "EX" %}-{% endif %}
            R$ {{ t.amount }}
          </td>
          <td>{{ t.category.name }}</td>
          <td>{{ t.account.name }}</td>
          <td>{{ t.credit_card.name|default:"-" }}</td>
          <td>{{ t.description }}</td>
          <td>
            <a href="{% url 'finance:edit_transaction' t.id %}" style="margin-right: 8px;">Editar</a>
            <form method="post" action="{% url 'finance:delete_transaction' t.id %}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja deletar este lançamento?');">
              {% csrf_token %}
              <button type="submit" class="logout-link" style="color: #c62828; padding: 0; margin: 0;">Deletar</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>Nenhum lançamento encontrado.</p>
{% endif %}

<script>
  function toggleInstallmentFields() {
    const chk = document.getElementById('id_is_installment');
    const box = document.getElementById('installment_fields');
    box.style.display = chk.checked ? 'block' : 'none';
  }
</script>

{% endblock %}
