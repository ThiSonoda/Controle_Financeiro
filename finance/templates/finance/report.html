{% extends "finance/base.html" %}
{% load static finance_extras %}

{% block content %}
<h1>Relatório - Gasto x Orçado</h1>

<form method="get" action="">
  <label for="id_year">Ano:</label>
  <input type="number" id="id_year" name="year" value="{{ year }}" min="2020" max="2100">
  <label for="id_month">Mês:</label>
  <select id="id_month" name="month" style="height: 35px">
    <option value="1" {% if month == 1 %}selected{% endif %}>Janeiro</option>
    <option value="2" {% if month == 2 %}selected{% endif %}>Fevereiro</option>
    <option value="3" {% if month == 3 %}selected{% endif %}>Março</option>
    <option value="4" {% if month == 4 %}selected{% endif %}>Abril</option>
    <option value="5" {% if month == 5 %}selected{% endif %}>Maio</option>
    <option value="6" {% if month == 6 %}selected{% endif %}>Junho</option>
    <option value="7" {% if month == 7 %}selected{% endif %}>Julho</option>
    <option value="8" {% if month == 8 %}selected{% endif %}>Agosto</option>
    <option value="9" {% if month == 9 %}selected{% endif %}>Setembro</option>
    <option value="10" {% if month == 10 %}selected{% endif %}>Outubro</option>
    <option value="11" {% if month == 11 %}selected{% endif %}>Novembro</option>
    <option value="12" {% if month == 12 %}selected{% endif %}>Dezembro</option>
  </select>
  <button type="submit" style="font-size: 14px;">Atualizar</button>
</form>

<hr>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
  <h2 style="margin: 0;">Mês {{ month }}/{{ year }}</h2>
  <div>
    {% if not is_edit_mode %}
      <a href="?year={{ year }}&month={{ month }}&edit=1" style="padding: 8px 16px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block;">Editar</a>
    {% else %}
      <button type="button" onclick="openTemplatesModal()" style="padding: 8px 16px; background-color: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 14px; line-height: 1.5; height: 36px; box-sizing: border-box;">Templates</button>
      <button type="button" onclick="openSaveTemplateModal()" style="padding: 8px 16px; background-color: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 14px; line-height: 1.5; height: 36px; box-sizing: border-box;">Salvar como Template</button>
      <button type="button" onclick="saveBudget()" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 14px; line-height: 1.5; height: 36px; box-sizing: border-box;">Salvar</button>
      <a href="?year={{ year }}&month={{ month }}" style="padding: 8px 16px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 14px; line-height: 1.5; height: 36px; box-sizing: border-box;">Cancelar</a>
    {% endif %}
  </div>
</div>

<!-- Formulário POST para salvar orçamentos -->
<form method="post" action="" id="budget-form" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="year" value="{{ year }}">
  <input type="hidden" name="month" value="{{ month }}">
  <!-- Os campos de orçamento serão adicionados dinamicamente pelo JavaScript -->
</form>

<!-- Resumo Financeiro -->
<div style="background-color: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ddd;">
  <h3 style="margin-top: 0;">Resumo Financeiro</h3>
  
  <!-- Primeira Linha: Valores Reais -->
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #ddd;">
    <div>
      <strong>Saldo Atual:</strong><br>
      {% if current_balance >= 0 %}
        <span style="font-size: 18px; color: #2e7d32;">R$ {{ current_balance|floatformat:2 }}</span>
      {% else %}
        <span style="font-size: 18px; color: #c62828;">R$ {{ current_balance|floatformat:2 }}</span>
      {% endif %}
    </div>
    <div>
      <strong>Total de Receitas:</strong><br>
      <span style="font-size: 18px; color: #2e7d32;">R$ {{ total_income|floatformat:2 }}</span>
    </div>
    <div>
      <strong>Total de Despesas:</strong><br>
      <span style="font-size: 18px; color: #c62828;">R$ {{ total_expenses|floatformat:2 }}</span>
    </div>
    <div>
      <strong>Diferença:</strong><br>
      {% if income_expense_diff >= 0 %}
        <span style="font-size: 18px; color: #2e7d32;">R$ {{ income_expense_diff|floatformat:2 }}</span>
      {% else %}
        <span style="font-size: 18px; color: #c62828;">R$ {{ income_expense_diff|floatformat:2 }}</span>
      {% endif %}
    </div>
  </div>
  
  <!-- Segunda Linha: Valores Orçados -->
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
    <div>
      <strong>Saldo Projetado:</strong><br>
      {% if projected_balance >= 0 %}
        <span style="font-size: 18px; color: #2e7d32;">R$ {{ projected_balance|floatformat:2 }}</span>
      {% else %}
        <span style="font-size: 18px; color: #c62828;">R$ {{ projected_balance|floatformat:2 }}</span>
      {% endif %}
    </div>
    <div>
      <strong>Receitas Orçadas:</strong><br>
      <span style="font-size: 18px; color: #2e7d32;">R$ {{ income_total_budget|floatformat:2 }}</span>
    </div>
    <div>
      <strong>Despesas Orçadas:</strong><br>
      <span style="font-size: 18px; color: #c62828;">R$ {{ expense_total_budget|floatformat:2 }}</span>
    </div>
    <div>
      <strong>Diferença:</strong><br>
      {% if budget_diff >= 0 %}
        <span style="font-size: 18px; color: #2e7d32;">R$ {{ budget_diff|floatformat:2 }}</span>
      {% else %}
        <span style="font-size: 18px; color: #c62828;">R$ {{ budget_diff|floatformat:2 }}</span>
      {% endif %}
    </div>
  </div>
</div>

{% if is_edit_mode %}
<!-- Resumo em Tempo Real do Modo de Edição -->
<div id="editModeSummary" style="position: sticky; top: 10px; z-index: 1000; background-color: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 2px solid #2196F3; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
  <h3 style="margin-top: 0; color: #1976d2;">Resumo do Orçamento (Atualização em Tempo Real)</h3>
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
    <div>
      <strong>Total Receitas:</strong><br>
      <span id="editModeTotalIncome" style="font-size: 18px; color: #2e7d32; font-weight: bold;">R$ 0.00</span>
    </div>
    <div>
      <strong>Total Despesas:</strong><br>
      <span id="editModeTotalExpenses" style="font-size: 18px; color: #c62828; font-weight: bold;">R$ 0.00</span>
    </div>
    <div>
      <strong>Saldo Final:</strong><br>
      <span id="editModeBalance" style="font-size: 18px; font-weight: bold;">R$ 0.00</span>
    </div>
  </div>
</div>
{% endif %}

{% if income_categories or expense_categories %}
  <!-- Tabela de Receitas -->
  {% if income_categories %}
    <h3 style="margin-top: 20px; margin-bottom: 10px;">Receitas</h3>
    <table border="1" cellspacing="0" cellpadding="4" style="margin-bottom: 30px; width: 100%; table-layout: fixed;">
      <colgroup>
        {% if is_edit_mode %}
          <col style="width: 12%;">
          <col style="width: 12%;">
          <col style="width: 30%;">
          <col style="width: 18%;">
          <col style="width: 12%;">
          <col style="width: 10%;">
          <col style="width: 6%;">
        {% else %}
          <col style="width: 16%;">
          <col style="width: 16%;">
          <col style="width: 18%;">
          <col style="width: 18%;">
          <col style="width: 18%;">
          <col style="width: 10%;">
          <col style="width: 4%;">
        {% endif %}
      </colgroup>
      <thead>
        <tr>
          <th>Categoria</th>
          <th>Subcategorias</th>
          <th>Orçado (R$)</th>
          {% if is_edit_mode %}
          <th>Comentário</th>
          {% endif %}
          <th>Recebido (R$)</th>
          <th>Diferença</th>
          <th>% Utilizado</th>
        </tr>
      </thead>
      <tbody>
        {% for cat in income_categories %}
          {% for subcat in cat.subcategories %}
            <tr>
              {% if forloop.first %}
                <td rowspan="{{ cat.subcategories|length }}" style="vertical-align: top; font-weight: bold;">
                  {{ cat.category_name }}
                </td>
              {% endif %}
              <td>{{ subcat.subcategory_name }}</td>
              <td class="budget-cell" data-subcategory-id="{{ subcat.subcategory_id }}" data-budget-value="{{ subcat.budget|default:0 }}">
                {% if is_edit_mode %}
                  <div style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; font-size: 13px; cursor: pointer;">
                      <input type="checkbox" 
                             class="use-items-checkbox" 
                             data-subcategory-id="{{ subcat.subcategory_id }}"
                             data-category-type="income"
                             {% if subcat.use_items %}checked{% endif %}
                             onchange="toggleItems(this, 'income')"
                             style="margin-right: 5px;">
                      <span>Usar itens</span>
                    </label>
                  </div>
                  <div class="budget-input-container" data-subcategory-id="{{ subcat.subcategory_id }}" style="{% if subcat.use_items %}display: none;{% endif %}">
                    <input type="number" 
                           class="budget-input" 
                           name="budget_{{ subcat.subcategory_id }}"
                           data-category-type="income" 
                           step="0.01" 
                           min="0" 
                           value="{{ subcat.budget_str|default:'0.00' }}" 
                           oninput="updateEditModeSummary()" 
                           style="width: 100%; box-sizing: border-box;">
                  </div>
                  <div class="budget-items-container" 
                       id="budget-items-{{ subcat.subcategory_id }}" 
                       data-subcategory-id="{{ subcat.subcategory_id }}"
                       data-category-type="income"
                       style="{% if not subcat.use_items %}display: none;{% endif %}">
                    <div class="items-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px;">
                      {% for item in subcat.budget_items %}
                        <div class="item-row" style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;">
                          <input type="text" 
                                 class="item-description" 
                                 placeholder="Descrição" 
                                 value="{{ item.description }}"
                                 style="flex: 1; padding: 4px; font-size: 13px;">
                          <input type="number" 
                                 class="item-amount" 
                                 placeholder="Valor" 
                                 step="0.01" 
                                 min="0" 
                                 value="{{ item.amount|decimal_input }}"
                                 oninput="updateItemsTotal({{ subcat.subcategory_id }}, 'income'); updateEditModeSummary();"
                                 style="width: 100px; padding: 4px; font-size: 13px;">
                          <input type="hidden" class="item-order" value="{{ item.order }}">
                          <button type="button" 
                                  onclick="removeItem(this); updateItemsTotal({{ subcat.subcategory_id }}, 'income'); updateEditModeSummary();" 
                                  style="padding: 4px 8px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                            ×
                          </button>
                        </div>
                      {% endfor %}
                    </div>
                    <button type="button" 
                            onclick="addItem({{ subcat.subcategory_id }}, 'income')" 
                            style="margin-top: 5px; padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                      + Adicionar Item
                    </button>
                    <div class="items-total" style="margin-top: 5px; font-weight: bold; font-size: 16px; text-align: right;">
                      Total: R$ <span id="items-total-{{ subcat.subcategory_id }}">0.00</span>
                    </div>
                  </div>
                  <input type="hidden" name="use_items_{{ subcat.subcategory_id }}" id="use_items_{{ subcat.subcategory_id }}" value="{% if subcat.use_items %}on{% endif %}">
                {% else %}
                  <span class="budget-text">R$ {{ subcat.budget|default:0|floatformat:2 }}</span>
                {% endif %}
              </td>
              {% if is_edit_mode %}
              <td>
                <textarea class="budget-comment-input" 
                          data-subcategory-id="{{ subcat.subcategory_id }}"
                          rows="2" 
                          placeholder="Comentário opcional..."
                          style="width: 100%; padding: 4px; box-sizing: border-box; font-size: 16px;">{{ subcat.budget_comment|default:'' }}</textarea>
              </td>
              {% endif %}
              <td>R$ {{ subcat.spent|floatformat:2 }}</td>
              <td>R$ {{ subcat.diff|floatformat:2 }}</td>
              <td>
                {% if subcat.percent %}
                  {{ subcat.percent|floatformat:1 }}%
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="2">Total Receitas</th>
          <th>R$ {{ income_total_budget|floatformat:2 }}</th>
          {% if is_edit_mode %}
          <th></th>
          {% endif %}
          <th>R$ {{ income_total_spent|floatformat:2 }}</th>
          <th>R$ {{ income_total_diff|floatformat:2 }}</th>
          <th>
            {% if income_total_percent %}
              {{ income_total_percent|floatformat:1 }}%
            {% else %}
              -
            {% endif %}
          </th>
        </tr>
      </tfoot>
    </table>
  {% endif %}

  <!-- Tabela de Despesas -->
  {% if expense_categories %}
    <h3 style="margin-top: 20px; margin-bottom: 10px;">Despesas</h3>
  <table border="1" cellspacing="0" cellpadding="4" style="width: 100%; table-layout: fixed;">
    <colgroup>
      {% if is_edit_mode %}
        <col style="width: 12%;">
        <col style="width: 12%;">
        <col style="width: 30%;">
        <col style="width: 18%;">
        <col style="width: 12%;">
        <col style="width: 10%;">
        <col style="width: 6%;">
      {% else %}
        <col style="width: 16%;">
        <col style="width: 16%;">
        <col style="width: 18%;">
        <col style="width: 18%;">
        <col style="width: 18%;">
        <col style="width: 10%;">
        <col style="width: 4%;">
      {% endif %}
    </colgroup>
    <thead>
      <tr>
        <th>Categoria</th>
          <th>Subcategorias</th>
        <th>Orçado (R$)</th>
          {% if is_edit_mode %}
          <th>Comentário</th>
          {% endif %}
        <th>Gasto (R$)</th>
        <th>Diferença</th>
        <th>% Utilizado</th>
      </tr>
    </thead>
    <tbody>
        {% for cat in expense_categories %}
          {% for subcat in cat.subcategories %}
            <tr {% if subcat.diff < 0 %}style="background-color:#ffd0d0"{% endif %}>
              {% if forloop.first %}
                <td rowspan="{{ cat.subcategories|length }}" style="vertical-align: top; font-weight: bold;">
                  {{ cat.category_name }}
                </td>
              {% endif %}
              <td>{{ subcat.subcategory_name }}</td>
              <td class="budget-cell" data-subcategory-id="{{ subcat.subcategory_id }}" data-budget-value="{{ subcat.budget|default:0 }}">
                {% if is_edit_mode %}
                  <div style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; font-size: 13px; cursor: pointer;">
                      <input type="checkbox" 
                             class="use-items-checkbox" 
                             data-subcategory-id="{{ subcat.subcategory_id }}"
                             data-category-type="expense"
                             {% if subcat.use_items %}checked{% endif %}
                             onchange="toggleItems(this, 'expense')"
                             style="margin-right: 5px;">
                      <span>Usar itens</span>
                    </label>
                  </div>
                  <div class="budget-input-container" data-subcategory-id="{{ subcat.subcategory_id }}" style="{% if subcat.use_items %}display: none;{% endif %}">
                    <input type="number" 
                           class="budget-input" 
                           name="budget_{{ subcat.subcategory_id }}"
                           data-category-type="expense" 
                           step="0.01" 
                           min="0" 
                           value="{{ subcat.budget_str|default:'0.00' }}" 
                           oninput="updateEditModeSummary()" 
                           style="width: 100%; box-sizing: border-box;">
                  </div>
                  <div class="budget-items-container" 
                       id="budget-items-{{ subcat.subcategory_id }}" 
                       data-subcategory-id="{{ subcat.subcategory_id }}"
                       data-category-type="expense"
                       style="{% if not subcat.use_items %}display: none;{% endif %}">
                    <div class="items-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px;">
                      {% for item in subcat.budget_items %}
                        <div class="item-row" style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;">
                          <input type="text" 
                                 class="item-description" 
                                 placeholder="Descrição" 
                                 value="{{ item.description }}"
                                 style="flex: 1; padding: 4px; font-size: 13px;">
                          <input type="number" 
                                 class="item-amount" 
                                 placeholder="Valor" 
                                 step="0.01" 
                                 min="0" 
                                 value="{{ item.amount|decimal_input }}"
                                 oninput="updateItemsTotal({{ subcat.subcategory_id }}, 'expense'); updateEditModeSummary();"
                                 style="width: 100px; padding: 4px; font-size: 13px;">
                          <input type="hidden" class="item-order" value="{{ item.order }}">
                          <button type="button" 
                                  onclick="removeItem(this); updateItemsTotal({{ subcat.subcategory_id }}, 'expense'); updateEditModeSummary();" 
                                  style="padding: 4px 8px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                            ×
                          </button>
                        </div>
                      {% endfor %}
                    </div>
                    <button type="button" 
                            onclick="addItem({{ subcat.subcategory_id }}, 'expense')" 
                            style="margin-top: 5px; padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                      + Adicionar Item
                    </button>
                    <div class="items-total" style="margin-top: 5px; font-weight: bold; font-size: 16px; text-align: right;">
                      Total: R$ <span id="items-total-{{ subcat.subcategory_id }}">0.00</span>
                    </div>
                  </div>
                  <input type="hidden" name="use_items_{{ subcat.subcategory_id }}" id="use_items_{{ subcat.subcategory_id }}" value="{% if subcat.use_items %}on{% endif %}">
                {% else %}
                  <span class="budget-text">R$ {{ subcat.budget|default:0|floatformat:2 }}</span>
                {% endif %}
              </td>
              {% if is_edit_mode %}
              <td>
                <textarea class="budget-comment-input" 
                          data-subcategory-id="{{ subcat.subcategory_id }}"
                          rows="2" 
                          placeholder="Comentário opcional..."
                          style="width: 100%; padding: 4px; box-sizing: border-box; font-size: 16px;">{{ subcat.budget_comment|default:'' }}</textarea>
              </td>
              {% endif %}
              <td>R$ {{ subcat.spent|floatformat:2 }}</td>
              <td>R$ {{ subcat.diff|floatformat:2 }}</td>
          <td>
                {% if subcat.percent %}
                  {{ subcat.percent|floatformat:1 }}%
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
          {% endfor %}
          {% if cat.subcategories %}
            <tr style="background-color: #f0f0f0; font-weight: bold;">
              <td colspan="2" style="text-align: right; padding-right: 10px;">Subtotal {{ cat.category_name }}:</td>
              <td>R$ {{ cat.total_budget|floatformat:2 }}</td>
              {% if is_edit_mode %}
              <td></td>
              {% endif %}
              <td>R$ {{ cat.total_spent|floatformat:2 }}</td>
              <td>R$ {{ cat.total_diff|floatformat:2 }}</td>
              <td>
                {% if cat.total_percent %}
                  {{ cat.total_percent|floatformat:1 }}%
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% endif %}
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
          <th colspan="2">Total Despesas</th>
          <th>R$ {{ expense_total_budget|floatformat:2 }}</th>
          {% if is_edit_mode %}
          <th></th>
          {% endif %}
          <th>R$ {{ expense_total_spent|floatformat:2 }}</th>
          <th>R$ {{ expense_total_diff|floatformat:2 }}</th>
        <th>
            {% if expense_total_percent %}
              {{ expense_total_percent|floatformat:1 }}%
          {% else %}
            -
          {% endif %}
        </th>
      </tr>
    </tfoot>
  </table>
  {% endif %}
{% else %}
  <p>Não há dados para este mês.</p>
{% endif %}

<!-- Modal de Templates -->
<div id="templatesModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">Templates de Orçamento</h2>
      <span onclick="closeTemplatesModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    </div>
    
    <div id="templatesList" style="margin-bottom: 20px;">
      <!-- Lista de templates será carregada aqui -->
    </div>
    
    <div style="border-top: 1px solid #ddd; padding-top: 20px;">
      <h3 style="margin-top: 0;">Criar Novo Template</h3>
      <form id="createTemplateForm" onsubmit="createTemplate(event)">
        <div style="margin-bottom: 10px;">
          <label for="templateName">Nome:</label>
          <input type="text" id="templateName" required style="width: 100%; padding: 8px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 10px;">
          <label for="templateDescription">Descrição (opcional):</label>
          <textarea id="templateDescription" rows="3" style="width: 100%; padding: 8px; box-sizing: border-box; font-size: 16px;"></textarea>
        </div>
        <div style="margin-bottom: 15px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
          <h4 style="margin-top: 0;">Valores de Orçamento por Subcategoria:</h4>
          <table border="1" cellspacing="0" cellpadding="4" style="width: 100%; font-size: 14px;">
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Subcategoria</th>
                <th>Valor (R$)</th>
                <th>Comentário</th>
              </tr>
            </thead>
            <tbody id="createTemplateSubcategories">
              {% for cat in subcategories_by_category %}
                {% for subcat in cat.subcategories %}
                  <tr>
                    {% if forloop.first %}
                      <td rowspan="{{ cat.subcategories|length }}" style="vertical-align: top; font-weight: bold;">
                        {{ cat.category_name }}
                      </td>
                    {% endif %}
                    <td>{{ subcat.name }}</td>
                    <td>
                      <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; font-size: 13px; cursor: pointer;">
                          <input type="checkbox" 
                                 class="template-use-items-checkbox" 
                                 data-subcategory-id="{{ subcat.id }}"
                                 data-category-is-income="{% if cat.category_is_income %}true{% else %}false{% endif %}"
                                 onchange="toggleTemplateItems(this, 'create')"
                                 style="margin-right: 5px;">
                          <span>Usar itens</span>
                        </label>
                      </div>
                      <div class="template-budget-input-container" data-subcategory-id="{{ subcat.id }}" style="display: block;">
                        <input type="number" 
                               class="template-budget-input" 
                               data-subcategory-id="{{ subcat.id }}"
                               data-category-is-income="{% if cat.category_is_income %}true{% else %}false{% endif %}"
                               step="0.01" 
                               min="0" 
                               value="" 
                               oninput="updateCreateTemplateTotals()"
                               style="width: 100%; padding: 4px; box-sizing: border-box;">
                      </div>
                      <div class="template-budget-items-container" 
                           id="template-budget-items-create-{{ subcat.id }}" 
                           data-subcategory-id="{{ subcat.id }}"
                           data-category-is-income="{% if cat.category_is_income %}true{% else %}false{% endif %}"
                           style="display: none;">
                        <div class="template-items-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; margin-bottom: 5px;">
                        </div>
                        <button type="button" 
                                onclick="addTemplateItem({{ subcat.id }}, 'create', {% if cat.category_is_income %}true{% else %}false{% endif %})" 
                                style="padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          + Adicionar Item
                        </button>
                        <div class="template-items-total" style="margin-top: 5px; font-weight: bold; font-size: 14px; text-align: right;">
                          Total: R$ <span id="template-items-total-create-{{ subcat.id }}">0.00</span>
                        </div>
                      </div>
                    </td>
                    <td>
                      <textarea class="template-comment-input" 
                                data-subcategory-id="{{ subcat.id }}"
                                rows="2" 
                                placeholder="Comentário opcional..."
                                style="width: 100%; padding: 4px; box-sizing: border-box; font-size: 16px;"></textarea>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div style="margin-bottom: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; border: 1px solid #ddd;">
          <h4 style="margin-top: 0; margin-bottom: 10px;">Resumo do Template:</h4>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            <div>
              <strong>Total Receitas:</strong><br>
              <span id="createTemplateTotalIncome" style="font-size: 16px; color: #2e7d32;">R$ 0.00</span>
            </div>
            <div>
              <strong>Total Despesas:</strong><br>
              <span id="createTemplateTotalExpenses" style="font-size: 16px; color: #c62828;">R$ 0.00</span>
            </div>
            <div>
              <strong>Saldo Final:</strong><br>
              <span id="createTemplateBalance" style="font-size: 16px; font-weight: bold;">R$ 0.00</span>
            </div>
          </div>
        </div>
        <button type="submit" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Criar Template</button>
      </form>
    </div>
  </div>
</div>

<!-- Modal para Salvar Template Atual -->
<div id="saveTemplateModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">Salvar Orçamento como Template</h2>
      <span onclick="closeSaveTemplateModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    </div>
    
    <form id="saveTemplateForm" onsubmit="saveCurrentAsTemplate(event)">
      <div style="margin-bottom: 10px;">
        <label for="saveTemplateName">Nome:</label>
        <input type="text" id="saveTemplateName" required style="width: 100%; padding: 8px; box-sizing: border-box;">
      </div>
      <div style="margin-bottom: 10px;">
        <label for="saveTemplateDescription">Descrição (opcional):</label>
        <textarea id="saveTemplateDescription" rows="3" style="width: 100%; padding: 8px; box-sizing: border-box; font-size: 16px;"></textarea>
      </div>
      <div style="text-align: right;">
        <button type="button" onclick="closeSaveTemplateModal()" style="padding: 8px 16px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">Cancelar</button>
        <button type="submit" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para Editar Template -->
<div id="editTemplateModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">Editar Template</h2>
      <span onclick="closeEditTemplateModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    </div>
    
    <form id="editTemplateForm" onsubmit="updateTemplate(event)">
      <input type="hidden" id="editTemplateId">
      <div style="margin-bottom: 10px;">
        <label for="editTemplateName">Nome:</label>
        <input type="text" id="editTemplateName" required style="width: 100%; padding: 8px; box-sizing: border-box;">
      </div>
      <div style="margin-bottom: 10px;">
        <label for="editTemplateDescription">Descrição (opcional):</label>
        <textarea id="editTemplateDescription" rows="3" style="width: 100%; padding: 8px; box-sizing: border-box; font-size: 16px;"></textarea>
      </div>
      <div style="margin-bottom: 15px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
        <h4 style="margin-top: 0;">Valores de Orçamento por Subcategoria:</h4>
        <table border="1" cellspacing="0" cellpadding="4" style="width: 100%; font-size: 14px;">
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Subcategoria</th>
              <th>Valor (R$)</th>
              <th>Comentário</th>
            </tr>
          </thead>
          <tbody id="editTemplateSubcategories">
            {% for cat in subcategories_by_category %}
              {% for subcat in cat.subcategories %}
                <tr>
                  {% if forloop.first %}
                    <td rowspan="{{ cat.subcategories|length }}" style="vertical-align: top; font-weight: bold;">
                      {{ cat.category_name }}
                    </td>
                  {% endif %}
                  <td>{{ subcat.name }}</td>
                  <td>
                    <div style="margin-bottom: 8px;">
                      <label style="display: flex; align-items: center; font-size: 13px; cursor: pointer;">
                        <input type="checkbox" 
                               class="template-use-items-checkbox" 
                               data-subcategory-id="{{ subcat.id }}"
                               data-category-is-income="{% if cat.category_is_income %}true{% else %}false{% endif %}"
                               onchange="toggleTemplateItems(this, 'edit')"
                               style="margin-right: 5px;">
                        <span>Usar itens</span>
                      </label>
                    </div>
                    <div class="template-budget-input-container" data-subcategory-id="{{ subcat.id }}" style="display: block;">
                      <input type="number" 
                             class="edit-template-budget-input" 
                             data-subcategory-id="{{ subcat.id }}"
                             data-category-is-income="{% if cat.category_is_income %}true{% else %}false{% endif %}"
                             step="0.01" 
                             min="0" 
                             value="" 
                             oninput="updateEditTemplateTotals()"
                             style="width: 100%; padding: 4px; box-sizing: border-box;">
                    </div>
                    <div class="template-budget-items-container" 
                         id="template-budget-items-edit-{{ subcat.id }}" 
                         data-subcategory-id="{{ subcat.id }}"
                         data-category-is-income="{% if cat.category_is_income %}true{% else %}false{% endif %}"
                         style="display: none;">
                      <div class="template-items-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; margin-bottom: 5px;">
                      </div>
                      <button type="button" 
                              onclick="addTemplateItem({{ subcat.id }}, 'edit', {% if cat.category_is_income %}true{% else %}false{% endif %})" 
                              style="padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        + Adicionar Item
                      </button>
                      <div class="template-items-total" style="margin-top: 5px; font-weight: bold; font-size: 14px; text-align: right;">
                        Total: R$ <span id="template-items-total-edit-{{ subcat.id }}">0.00</span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <textarea class="edit-template-comment-input" 
                              data-subcategory-id="{{ subcat.id }}"
                              rows="2" 
                              placeholder="Comentário opcional..."
                              style="width: 100%; padding: 4px; box-sizing: border-box; font-size: 12px; font-size: 16px;"></textarea>
                  </td>
                </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="margin-bottom: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; border: 1px solid #ddd;">
        <h4 style="margin-top: 0; margin-bottom: 10px;">Resumo do Template:</h4>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
          <div>
            <strong>Total Receitas:</strong><br>
            <span id="editTemplateTotalIncome" style="font-size: 16px; color: #2e7d32;">R$ 0.00</span>
          </div>
          <div>
            <strong>Total Despesas:</strong><br>
            <span id="editTemplateTotalExpenses" style="font-size: 16px; color: #c62828;">R$ 0.00</span>
          </div>
          <div>
            <strong>Saldo Final:</strong><br>
            <span id="editTemplateBalance" style="font-size: 16px; font-weight: bold;">R$ 0.00</span>
          </div>
        </div>
      </div>
      <div style="text-align: right;">
        <button type="button" onclick="closeEditTemplateModal()" style="padding: 8px 16px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">Cancelar</button>
        <button type="submit" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Salvar</button>
      </div>
    </form>
  </div>
</div>

{% if is_edit_mode %}
<script>
const currentYear = {{ year }};
const currentMonth = {{ month }};

function saveBudget() {
  const form = document.getElementById('budget-form');

  // Limpar campos existentes (se houver)
  const existingInputs = form.querySelectorAll('input[name^="budget_"], input[name^="comment_"], input[name^="use_items_"], input[name^="item_"]');
  existingInputs.forEach(input => input.remove());

  // Coletar todos os valores de orçamento e comentários
  document.querySelectorAll('.budget-cell').forEach(cell => {
    const subcategoryId = cell.getAttribute('data-subcategory-id');
    const useItemsCheckbox = cell.querySelector('.use-items-checkbox');
    const useItems = useItemsCheckbox && useItemsCheckbox.checked;
    
    let value = '';
    
    if (useItems) {
      // Se está usando itens, calcular total dos itens
      const itemsContainer = document.getElementById(`budget-items-${subcategoryId}`);
      const itemsList = itemsContainer.querySelector('.items-list');
      let itemsTotal = 0;
      
      if (itemsList) {
        itemsList.querySelectorAll('.item-amount').forEach(input => {
          itemsTotal += parseFloat(input.value) || 0;
        });
      }
      
      value = itemsTotal > 0 ? itemsTotal.toString() : '';
      
      // Adicionar campos dos itens
      const itemRows = itemsList.querySelectorAll('.item-row');
      itemRows.forEach((row, index) => {
        const descInput = row.querySelector('.item-description');
        const amountInput = row.querySelector('.item-amount');
        const orderInput = row.querySelector('.item-order');
        
        if (descInput && amountInput && descInput.value.trim() && amountInput.value.trim()) {
          const descField = document.createElement('input');
          descField.type = 'hidden';
          descField.name = `item_desc_${subcategoryId}_${index}`;
          descField.value = descInput.value.trim();
          form.appendChild(descField);
          
          const amountField = document.createElement('input');
          amountField.type = 'hidden';
          amountField.name = `item_amount_${subcategoryId}_${index}`;
          amountField.value = amountInput.value.trim();
          form.appendChild(amountField);
          
          const orderField = document.createElement('input');
          orderField.type = 'hidden';
          orderField.name = `item_order_${subcategoryId}_${index}`;
          orderField.value = orderInput ? orderInput.value : index;
          form.appendChild(orderField);
        }
      });
      
      // Adicionar checkbox use_items
      const useItemsField = document.createElement('input');
      useItemsField.type = 'hidden';
      useItemsField.name = `use_items_${subcategoryId}`;
      useItemsField.value = 'on';
      form.appendChild(useItemsField);
    } else {
      // Se não está usando itens, pegar valor do input direto
      const input = cell.querySelector('.budget-input');
      if (input) {
        value = input.value.trim();
      }
      
      // Se vazio ou 0, enviar string vazia (será tratado como deletar orçamento)
      if (value === '' || value === '0' || parseFloat(value) === 0) {
        value = '';
      }
    }

    // Criar campo hidden para o valor do orçamento
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = `budget_${subcategoryId}`;
    hiddenInput.value = value;
    form.appendChild(hiddenInput);

    // Coletar comentário se existir
    const commentInput = document.querySelector(`.budget-comment-input[data-subcategory-id="${subcategoryId}"]`);
    if (commentInput) {
      const commentValue = commentInput.value.trim();
      const hiddenCommentInput = document.createElement('input');
      hiddenCommentInput.type = 'hidden';
      hiddenCommentInput.name = `comment_${subcategoryId}`;
      hiddenCommentInput.value = commentValue;
      form.appendChild(hiddenCommentInput);
    }
  });

  // Submeter formulário
  form.submit();
}

function openTemplatesModal() {
  document.getElementById('templatesModal').style.display = 'block';
  loadTemplates();
}

function closeTemplatesModal() {
  document.getElementById('templatesModal').style.display = 'none';
}

function openSaveTemplateModal() {
  document.getElementById('saveTemplateModal').style.display = 'block';
}

function closeSaveTemplateModal() {
  document.getElementById('saveTemplateModal').style.display = 'none';
  document.getElementById('saveTemplateForm').reset();
}

function openEditTemplateModal(templateId) {
  document.getElementById('editTemplateModal').style.display = 'block';
  loadTemplateForEdit(templateId);
}

function closeEditTemplateModal() {
  document.getElementById('editTemplateModal').style.display = 'none';
  document.getElementById('editTemplateForm').reset();
  // Limpar todos os valores dos inputs
  document.querySelectorAll('.edit-template-budget-input').forEach(input => {
    input.value = '';
  });
  document.querySelectorAll('.edit-template-comment-input').forEach(textarea => {
    textarea.value = '';
  });
  // Resetar totais
  updateEditTemplateTotals();
}

function loadTemplates() {
  fetch('{% url "finance:budget_template_list" %}')
    .then(response => response.json())
    .then(data => {
      const listDiv = document.getElementById('templatesList');
      if (data.templates.length === 0) {
        listDiv.innerHTML = '<p>Nenhum template cadastrado.</p>';
        return;
      }
      
      let html = '<h3 style="margin-top: 0;">Templates Disponíveis</h3>';
      data.templates.forEach(template => {
        html += `
          <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 5px 0;">${escapeHtml(template.name)}</h4>
                ${template.description ? `<p style="margin: 0 0 5px 0; color: #666;">${escapeHtml(template.description)}</p>` : ''}
                <p style="margin: 0; font-size: 12px; color: #999;">Criado em: ${template.created_at} | ${template.item_count} itens</p>
              </div>
              <div>
                <button onclick="applyTemplate(${template.id})" style="padding: 6px 12px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Aplicar</button>
                <button onclick="openEditTemplateModal(${template.id})" style="padding: 6px 12px; background-color: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Editar</button>
                <button onclick="deleteTemplate(${template.id})" style="padding: 6px 12px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Deletar</button>
              </div>
            </div>
          </div>
        `;
      });
      listDiv.innerHTML = html;
    })
    .catch(error => {
      console.error('Erro ao carregar templates:', error);
      alert('Erro ao carregar templates.');
    });
}

function loadTemplateForEdit(templateId) {
  fetch(`{% url "finance:budget_template_edit" 0 %}`.replace('0', templateId))
    .then(response => response.json())
    .then(data => {
      document.getElementById('editTemplateId').value = data.id;
      document.getElementById('editTemplateName').value = data.name;
      document.getElementById('editTemplateDescription').value = data.description || '';
      
      // Limpar todos os valores primeiro
      document.querySelectorAll('.edit-template-budget-input').forEach(input => {
        input.value = '';
      });
      document.querySelectorAll('.edit-template-comment-input').forEach(textarea => {
        textarea.value = '';
      });
      
      // Preencher os valores do template
      if (data.items && data.items.length > 0) {
        data.items.forEach(item => {
          const checkbox = document.querySelector(`.template-use-items-checkbox[data-subcategory-id="${item.subcategory_id}"]`);
          const input = document.querySelector(`.edit-template-budget-input[data-subcategory-id="${item.subcategory_id}"]`);
          const inputContainer = document.querySelector(`.template-budget-input-container[data-subcategory-id="${item.subcategory_id}"]`);
          const itemsContainer = document.getElementById(`template-budget-items-edit-${item.subcategory_id}`);
          const commentInput = document.querySelector(`.edit-template-comment-input[data-subcategory-id="${item.subcategory_id}"]`);
          
          if (commentInput) {
            commentInput.value = item.comment || '';
          }
          
          if (item.use_items && itemsContainer) {
            // Marcar checkbox
            if (checkbox) checkbox.checked = true;
            // Esconder input direto
            if (inputContainer) inputContainer.style.display = 'none';
            // Mostrar container de itens
            itemsContainer.style.display = 'block';
            
            // Preencher itens
            const itemsList = itemsContainer.querySelector('.template-items-list');
            if (itemsList && item.items && item.items.length > 0) {
              itemsList.innerHTML = '';
              item.items.forEach((templateItem, index) => {
                const itemRow = document.createElement('div');
                itemRow.className = 'template-item-row';
                itemRow.style.cssText = 'display: flex; gap: 5px; margin-bottom: 5px; align-items: center;';
                itemRow.innerHTML = `
                  <input type="text" 
                         class="template-item-description" 
                         placeholder="Descrição" 
                         value="${escapeHtml(templateItem.description)}"
                         style="flex: 1; padding: 4px; font-size: 12px;">
                  <input type="number" 
                         class="template-item-amount" 
                         placeholder="Valor" 
                         step="0.01" 
                         min="0" 
                         value="${templateItem.amount.replace(',', '.')}"
                         oninput="updateTemplateItemsTotal(${item.subcategory_id}, 'edit'); updateEditTemplateTotals();"
                         style="width: 100px; padding: 4px; font-size: 12px;">
                  <input type="hidden" class="template-item-order" value="${templateItem.order || index}">
                  <button type="button" 
                          onclick="removeTemplateItem(this); updateTemplateItemsTotal(${item.subcategory_id}, 'edit'); updateEditTemplateTotals();" 
                          style="padding: 4px 8px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                    ×
                  </button>
                `;
                itemsList.appendChild(itemRow);
              });
              updateTemplateItemsTotal(item.subcategory_id, 'edit');
            }
          } else if (input) {
            // Não usar itens, preencher input direto
            input.value = item.amount.replace(',', '.');
          }
        });
      }

      // Atualizar totais após carregar os valores
      updateEditTemplateTotals();
    })
    .catch(error => {
      console.error('Erro ao carregar template:', error);
      alert('Erro ao carregar template.');
    });
}

function applyTemplate(templateId) {
  const replaceMode = confirm('Deseja substituir TODOS os valores existentes?\n\nOK = Substituir todos\nCancelar = Preencher apenas campos vazios');
  const mode = replaceMode ? 'all' : 'empty';
  
  fetch('{% url "finance:budget_template_apply" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      template_id: templateId,
      year: currentYear,
      month: currentMonth,
      replace_mode: mode
    })
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert('Erro: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro ao aplicar template:', error);
      alert('Erro ao aplicar template.');
    });
}

function createTemplate(event) {
  event.preventDefault();
  const name = document.getElementById('templateName').value.trim();
  const description = document.getElementById('templateDescription').value.trim();

  // Coletar valores dos inputs do modal
  const items = [];
  document.querySelectorAll('#createTemplateSubcategories tr').forEach(row => {
    const subcategoryIdInput = row.querySelector('[data-subcategory-id]');
    if (!subcategoryIdInput) return;
    
    const subcategoryId = subcategoryIdInput.getAttribute('data-subcategory-id');
    const useItemsCheckbox = row.querySelector('.template-use-items-checkbox');
    const useItems = useItemsCheckbox && useItemsCheckbox.checked;
    
    let amount = '';
    let templateItems = [];
    
    if (useItems) {
      // Coletar itens
      const itemsContainer = document.getElementById(`template-budget-items-create-${subcategoryId}`);
      if (itemsContainer) {
        const itemsList = itemsContainer.querySelector('.template-items-list');
        if (itemsList) {
          itemsList.querySelectorAll('.template-item-row').forEach(itemRow => {
            const descInput = itemRow.querySelector('.template-item-description');
            const amountInput = itemRow.querySelector('.template-item-amount');
            const orderInput = itemRow.querySelector('.template-item-order');
            
            if (descInput && amountInput && descInput.value.trim() && amountInput.value.trim()) {
              templateItems.push({
                description: descInput.value.trim(),
                amount: amountInput.value.trim(),
                order: parseInt(orderInput ? orderInput.value : 0)
              });
            }
          });
        }
        
        // Calcular total dos itens
        let itemsTotal = 0;
        templateItems.forEach(item => {
          itemsTotal += parseFloat(item.amount) || 0;
        });
        amount = itemsTotal > 0 ? itemsTotal.toString() : '';
      }
    } else {
      // Usar valor do input direto
      const input = row.querySelector('.template-budget-input');
      if (input) {
        amount = input.value.trim();
      }
    }
    
    if (amount && parseFloat(amount) > 0) {
      const commentInput = row.querySelector(`.template-comment-input[data-subcategory-id="${subcategoryId}"]`);
      const comment = commentInput ? commentInput.value.trim() : '';
      items.push({
        subcategory_id: parseInt(subcategoryId),
        amount: amount,
        comment: comment,
        use_items: useItems,
        items: templateItems
      });
    }
  });
  
  fetch('{% url "finance:budget_template_create" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      name: name,
      description: description,
      items: items
    })
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Template criado com sucesso!');
        document.getElementById('createTemplateForm').reset();
        loadTemplates();
      } else {
        alert('Erro: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro ao criar template:', error);
      alert('Erro ao criar template.');
    });
}

function updateTemplate(event) {
  event.preventDefault();
  const templateId = document.getElementById('editTemplateId').value;
  const name = document.getElementById('editTemplateName').value.trim();
  const description = document.getElementById('editTemplateDescription').value.trim();
  
  // Coletar valores dos inputs do modal de edição
  const items = [];
  document.querySelectorAll('#editTemplateSubcategories tr').forEach(row => {
    const subcategoryIdInput = row.querySelector('[data-subcategory-id]');
    if (!subcategoryIdInput) return;
    
    const subcategoryId = subcategoryIdInput.getAttribute('data-subcategory-id');
    const useItemsCheckbox = row.querySelector('.template-use-items-checkbox');
    const useItems = useItemsCheckbox && useItemsCheckbox.checked;
    
    let amount = '';
    let templateItems = [];
    
    if (useItems) {
      // Coletar itens
      const itemsContainer = document.getElementById(`template-budget-items-edit-${subcategoryId}`);
      if (itemsContainer) {
        const itemsList = itemsContainer.querySelector('.template-items-list');
        if (itemsList) {
          itemsList.querySelectorAll('.template-item-row').forEach(itemRow => {
            const descInput = itemRow.querySelector('.template-item-description');
            const amountInput = itemRow.querySelector('.template-item-amount');
            const orderInput = itemRow.querySelector('.template-item-order');
            
            if (descInput && amountInput && descInput.value.trim() && amountInput.value.trim()) {
              templateItems.push({
                description: descInput.value.trim(),
                amount: amountInput.value.trim(),
                order: parseInt(orderInput ? orderInput.value : 0)
              });
            }
          });
        }
        
        // Calcular total dos itens
        let itemsTotal = 0;
        templateItems.forEach(item => {
          itemsTotal += parseFloat(item.amount) || 0;
        });
        amount = itemsTotal > 0 ? itemsTotal.toString() : '';
      }
    } else {
      // Usar valor do input direto
      const input = row.querySelector('.edit-template-budget-input');
      if (input) {
        amount = input.value.trim();
      }
    }
    
    if (amount && parseFloat(amount) > 0) {
      const commentInput = row.querySelector(`.edit-template-comment-input[data-subcategory-id="${subcategoryId}"]`);
      const comment = commentInput ? commentInput.value.trim() : '';
      items.push({
        subcategory_id: parseInt(subcategoryId),
        amount: amount,
        comment: comment,
        use_items: useItems,
        items: templateItems
      });
    }
  });
  
  fetch(`{% url "finance:budget_template_edit" 0 %}`.replace('0', templateId), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      name: name,
      description: description,
      items: items
    })
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Template atualizado com sucesso!');
        closeEditTemplateModal();
        loadTemplates();
      } else {
        alert('Erro: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro ao atualizar template:', error);
      alert('Erro ao atualizar template.');
    });
}

function saveCurrentAsTemplate(event) {
  event.preventDefault();
  const name = document.getElementById('saveTemplateName').value.trim();
  const description = document.getElementById('saveTemplateDescription').value.trim();
  
  fetch('{% url "finance:budget_template_save_current" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      name: name,
      description: description,
      year: currentYear,
      month: currentMonth
    })
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Template salvo com sucesso!');
        closeSaveTemplateModal();
        if (document.getElementById('templatesModal').style.display === 'block') {
          loadTemplates();
        }
      } else {
        alert('Erro: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro ao salvar template:', error);
      alert('Erro ao salvar template.');
    });
}

function deleteTemplate(templateId) {
  if (!confirm('Tem certeza que deseja deletar este template?')) {
    return;
  }
  
  fetch(`{% url "finance:budget_template_delete" 0 %}`.replace('0', templateId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Template deletado com sucesso!');
        loadTemplates();
      } else {
        alert('Erro: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro ao deletar template:', error);
      alert('Erro ao deletar template.');
    });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Função para calcular e atualizar totais do template de criação
function toggleTemplateItems(checkbox, mode) {
  const subcategoryId = checkbox.getAttribute('data-subcategory-id');
  const container = document.getElementById(`template-budget-items-${mode}-${subcategoryId}`);
  const inputContainer = checkbox.closest('td').querySelector('.template-budget-input-container');
  
  if (checkbox.checked) {
    container.style.display = 'block';
    if (inputContainer) inputContainer.style.display = 'none';
    updateTemplateItemsTotal(subcategoryId, mode);
  } else {
    container.style.display = 'none';
    if (inputContainer) inputContainer.style.display = 'block';
  }
  
  if (mode === 'create') {
    updateCreateTemplateTotals();
  } else {
    updateEditTemplateTotals();
  }
}

function addTemplateItem(subcategoryId, mode, isIncome) {
  const container = document.getElementById(`template-budget-items-${mode}-${subcategoryId}`);
  const itemsList = container.querySelector('.template-items-list');
  const itemCount = itemsList.querySelectorAll('.template-item-row').length;
  
  const itemRow = document.createElement('div');
  itemRow.className = 'template-item-row';
  itemRow.style.cssText = 'display: flex; gap: 5px; margin-bottom: 5px; align-items: center;';
  
  itemRow.innerHTML = `
    <input type="text" 
           class="template-item-description" 
           placeholder="Descrição" 
           style="flex: 1; padding: 4px; font-size: 12px;">
    <input type="number" 
           class="template-item-amount" 
           placeholder="Valor" 
           step="0.01" 
           min="0" 
           value="0.00"
           oninput="updateTemplateItemsTotal(${subcategoryId}, '${mode}'); ${mode === 'create' ? 'updateCreateTemplateTotals();' : 'updateEditTemplateTotals();'}"
           style="width: 100px; padding: 4px; font-size: 12px;">
    <input type="hidden" class="template-item-order" value="${itemCount}">
    <button type="button" 
            onclick="removeTemplateItem(this); updateTemplateItemsTotal(${subcategoryId}, '${mode}'); ${mode === 'create' ? 'updateCreateTemplateTotals();' : 'updateEditTemplateTotals();'}" 
            style="padding: 4px 8px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
      ×
    </button>
  `;
  
  itemsList.appendChild(itemRow);
  updateTemplateItemsTotal(subcategoryId, mode);
  if (mode === 'create') {
    updateCreateTemplateTotals();
  } else {
    updateEditTemplateTotals();
  }
}

function removeTemplateItem(button) {
  button.closest('.template-item-row').remove();
}

function updateTemplateItemsTotal(subcategoryId, mode) {
  const container = document.getElementById(`template-budget-items-${mode}-${subcategoryId}`);
  if (!container) return;
  
  const itemsList = container.querySelector('.template-items-list');
  if (!itemsList) return;
  
  const itemRows = itemsList.querySelectorAll('.template-item-row');
  let total = 0;
  
  itemRows.forEach((row, index) => {
    const amountInput = row.querySelector('.template-item-amount');
    const amount = parseFloat(amountInput.value) || 0;
    total += amount;
    
    const orderInput = row.querySelector('.template-item-order');
    if (orderInput) orderInput.value = index;
  });
  
  const totalSpan = document.getElementById(`template-items-total-${mode}-${subcategoryId}`);
  if (totalSpan) {
    totalSpan.textContent = total.toFixed(2);
  }
}

function updateCreateTemplateTotals() {
  let totalIncome = 0;
  let totalExpenses = 0;

  // Somar valores dos inputs diretos
  document.querySelectorAll('.template-budget-input-container[style*="display: block"] .template-budget-input').forEach(input => {
    const value = parseFloat(input.value) || 0;
    const isIncome = input.getAttribute('data-category-is-income') === 'true';

    if (isIncome) {
      totalIncome += value;
    } else {
      totalExpenses += value;
    }
  });

  // Somar valores dos itens
  document.querySelectorAll('.template-budget-items-container[style*="display: block"]').forEach(container => {
    const isIncome = container.getAttribute('data-category-is-income') === 'true';
    const itemsList = container.querySelector('.template-items-list');
    let itemsTotal = 0;
    
    if (itemsList) {
      itemsList.querySelectorAll('.template-item-amount').forEach(input => {
        itemsTotal += parseFloat(input.value) || 0;
      });
    }
    
    if (isIncome) {
      totalIncome += itemsTotal;
    } else {
      totalExpenses += itemsTotal;
    }
  });

  const balance = totalIncome - totalExpenses;

  document.getElementById('createTemplateTotalIncome').textContent = 'R$ ' + totalIncome.toFixed(2);
  document.getElementById('createTemplateTotalExpenses').textContent = 'R$ ' + totalExpenses.toFixed(2);

  const balanceElement = document.getElementById('createTemplateBalance');
  balanceElement.textContent = 'R$ ' + balance.toFixed(2);
  balanceElement.style.color = balance >= 0 ? '#2e7d32' : '#c62828';
}

// Função para calcular e atualizar totais do template de edição
function updateEditTemplateTotals() {
  let totalIncome = 0;
  let totalExpenses = 0;

  // Somar valores dos inputs diretos
  document.querySelectorAll('.template-budget-input-container[style*="display: block"] .edit-template-budget-input').forEach(input => {
    const value = parseFloat(input.value) || 0;
    const isIncome = input.getAttribute('data-category-is-income') === 'true';

    if (isIncome) {
      totalIncome += value;
    } else {
      totalExpenses += value;
    }
  });

  // Somar valores dos itens
  document.querySelectorAll('.template-budget-items-container[style*="display: block"]').forEach(container => {
    const isIncome = container.getAttribute('data-category-is-income') === 'true';
    const itemsList = container.querySelector('.template-items-list');
    let itemsTotal = 0;
    
    if (itemsList) {
      itemsList.querySelectorAll('.template-item-amount').forEach(input => {
        itemsTotal += parseFloat(input.value) || 0;
      });
    }
    
    if (isIncome) {
      totalIncome += itemsTotal;
    } else {
      totalExpenses += itemsTotal;
    }
  });
  
  const balance = totalIncome - totalExpenses;
  
  document.getElementById('editTemplateTotalIncome').textContent = 'R$ ' + totalIncome.toFixed(2);
  document.getElementById('editTemplateTotalExpenses').textContent = 'R$ ' + totalExpenses.toFixed(2);
  
  const balanceElement = document.getElementById('editTemplateBalance');
  balanceElement.textContent = 'R$ ' + balance.toFixed(2);
  balanceElement.style.color = balance >= 0 ? '#2e7d32' : '#c62828';
}

// Função para calcular e atualizar resumo do modo de edição em tempo real
function toggleItems(checkbox, categoryType) {
  const subcategoryId = checkbox.getAttribute('data-subcategory-id');
  const container = document.getElementById(`budget-items-${subcategoryId}`);
  const inputContainer = document.querySelector(`.budget-input-container[data-subcategory-id="${subcategoryId}"]`);
  const hiddenInput = document.getElementById(`use_items_${subcategoryId}`);
  
  if (checkbox.checked) {
    container.style.display = 'block';
    if (inputContainer) inputContainer.style.display = 'none';
    if (hiddenInput) hiddenInput.value = 'on';
    updateItemsTotal(subcategoryId, categoryType);
  } else {
    container.style.display = 'none';
    if (inputContainer) inputContainer.style.display = 'block';
    if (hiddenInput) hiddenInput.value = '';
  }
  
  updateEditModeSummary();
}

function addItem(subcategoryId, categoryType) {
  const container = document.getElementById(`budget-items-${subcategoryId}`);
  const itemsList = container.querySelector('.items-list');
  const itemCount = itemsList.querySelectorAll('.item-row').length;
  
  const itemRow = document.createElement('div');
  itemRow.className = 'item-row';
  itemRow.style.cssText = 'display: flex; gap: 5px; margin-bottom: 5px; align-items: center;';
  
  itemRow.innerHTML = `
    <input type="text" 
           class="item-description" 
           placeholder="Descrição" 
           style="flex: 1; padding: 4px; font-size: 13px;">
    <input type="number" 
           class="item-amount" 
           placeholder="Valor" 
           step="0.01" 
           min="0" 
           value="0.00"
           oninput="updateItemsTotal(${subcategoryId}, '${categoryType}'); updateEditModeSummary();"
           style="width: 100px; padding: 4px; font-size: 13px;">
    <input type="hidden" class="item-order" value="${itemCount}">
    <button type="button" 
            onclick="removeItem(this); updateItemsTotal(${subcategoryId}, '${categoryType}'); updateEditModeSummary();" 
            style="padding: 4px 8px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
      ×
    </button>
  `;
  
  itemsList.appendChild(itemRow);
  updateItemsTotal(subcategoryId, categoryType);
  updateEditModeSummary();
}

function removeItem(button) {
  button.closest('.item-row').remove();
}

function updateItemsTotal(subcategoryId, categoryType) {
  const container = document.getElementById(`budget-items-${subcategoryId}`);
  const itemsList = container.querySelector('.items-list');
  const itemRows = itemsList.querySelectorAll('.item-row');
  let total = 0;
  
  itemRows.forEach((row, index) => {
    const amountInput = row.querySelector('.item-amount');
    const amount = parseFloat(amountInput.value) || 0;
    total += amount;
    
    // Atualizar ordem
    const orderInput = row.querySelector('.item-order');
    if (orderInput) orderInput.value = index;
  });
  
  const totalSpan = document.getElementById(`items-total-${subcategoryId}`);
  if (totalSpan) {
    totalSpan.textContent = total.toFixed(2);
  }
}

function updateEditModeSummary() {
  let totalIncome = 0;
  let totalExpenses = 0;

  // Somar valores dos inputs diretos (quando não está usando itens)
  document.querySelectorAll('.budget-input:not([style*="display: none"])').forEach(input => {
    const value = parseFloat(input.value) || 0;
    const categoryType = input.getAttribute('data-category-type');

    if (categoryType === 'income') {
      totalIncome += value;
    } else if (categoryType === 'expense') {
      totalExpenses += value;
    }
  });

  // Somar valores dos itens (quando está usando itens)
  document.querySelectorAll('.budget-items-container[style*="display: block"]').forEach(container => {
    const categoryType = container.getAttribute('data-category-type');
    const itemsList = container.querySelector('.items-list');
    let itemsTotal = 0;
    
    if (itemsList) {
      itemsList.querySelectorAll('.item-amount').forEach(input => {
        itemsTotal += parseFloat(input.value) || 0;
      });
    }
    
    if (categoryType === 'income') {
      totalIncome += itemsTotal;
    } else if (categoryType === 'expense') {
      totalExpenses += itemsTotal;
    }
  });

  const balance = totalIncome - totalExpenses;

  const totalIncomeElement = document.getElementById('editModeTotalIncome');
  const totalExpensesElement = document.getElementById('editModeTotalExpenses');
  
  if (totalIncomeElement) {
    totalIncomeElement.textContent = 'R$ ' + totalIncome.toFixed(2);
  }
  if (totalExpensesElement) {
    totalExpensesElement.textContent = 'R$ ' + totalExpenses.toFixed(2);
  }

  const balanceElement = document.getElementById('editModeBalance');
  if (balanceElement) {
    balanceElement.textContent = 'R$ ' + balance.toFixed(2);
    balanceElement.style.color = balance >= 0 ? '#2e7d32' : '#c62828';
  }
}

// Atualizar resumo ao carregar a página no modo de edição
if (document.getElementById('editModeSummary')) {
  // Inicializar totais dos itens
  document.querySelectorAll('.budget-items-container').forEach(container => {
    const subcategoryId = container.getAttribute('data-subcategory-id');
    const categoryType = container.getAttribute('data-category-type');
    if (container.style.display !== 'none') {
      updateItemsTotal(subcategoryId, categoryType);
    }
  });
  updateEditModeSummary();
}

// Fechar modais ao clicar fora
window.onclick = function(event) {
  const templatesModal = document.getElementById('templatesModal');
  const saveTemplateModal = document.getElementById('saveTemplateModal');
  const editTemplateModal = document.getElementById('editTemplateModal');
  
  if (event.target === templatesModal) {
    closeTemplatesModal();
  }
  if (event.target === saveTemplateModal) {
    closeSaveTemplateModal();
  }
  if (event.target === editTemplateModal) {
    closeEditTemplateModal();
  }
}
</script>
{% endif %}

{% endblock %}
